micello.maps.version="1.0";micello.maps.PROTOCOL="http";if(location.protocol=="https:"){micello.maps.PROTOCOL="https"}micello.maps.HOST_URL=micello.maps.PROTOCOL+"://eng.micello.com/mfs/ms/v1/mfile";micello.maps.ROUTE_URL=micello.maps.PROTOCOL+"://eng.micello.com/navigation";micello.maps.SEARCH_URL=micello.maps.PROTOCOL+"://eng.micello.com/search";micello.msgs=new Array();micello.logDiv=null;micello.log=function(a){if(this.logDiv){console.log(a);this.msgs.push(a);this.logDiv.innerHTML=a+"<br>"+this.logDiv.innerHTML}};micello.getScriptPath=function(a,f){for(i=0;i<a.length;i++){var c=a[i].src;var b=c.length-f.length;if(c.substr(b)==f){return c.substr(0,b)}}return null};micello.getScriptUrl=function(){var a=document.getElementsByTagName("script");var f=["micellomap_impl.js","combined.js","micello.js","micellomap.css"];var c;var b;for(c=0;c<f.length;c++){b=micello.getScriptPath(a,f[c]);if(b!=null){return b}}micello.maps.errorHandler("Error: api context not found!");return""};micello.SCRIPT_URL=micello.getScriptUrl();micello.maps.themeMapUrl=undefined;micello.maps.themeMapName="Standard";micello.maps.themeUrl=undefined;micello.maps.themeName="Standard";micello.maps.stringsUrl=undefined;micello.maps.stringsName="Standard";micello.maps.lang="en";micello.maps.defaultLang=undefined;if(!micello){micello={}}if(!micello.maps){micello.mapstruct={}}micello.maps.shapetype={};micello.maps.shapetype.NONE=0;micello.maps.shapetype.PATH=2;micello.maps.geomtype={};micello.maps.geomtype.NONE=0;micello.maps.geomtype.LINE=1;micello.maps.geomtype.AREA=2;micello.maps.geomtype.LINEAR_AREA=3;micello.maps.path={};micello.maps.path.MOVE_TO=0;micello.maps.path.LINE_TO=1;micello.maps.path.QUAD_TO=2;micello.maps.path.CUBE_TO=3;micello.maps.path.CLOSE=4;micello.maps.labeltype={};micello.maps.labeltype.NONE=0;micello.maps.labeltype.TEXT=1;micello.maps.labeltype.ICON=2;micello.maps.labeltype.IMAGE=3;micello.maps.labeltype.GEOM=4;micello.maps.markertype={};micello.maps.markertype.NONE=0;micello.maps.markertype.NAMED=1;micello.maps.markertype.IMAGE=2;micello.maps.popuptype={};micello.maps.popuptype.MENU=1;micello.maps.popuptype.INFOWINDOW=2;micello.maps.infoentrytype={};micello.maps.infoentrytype.PHONE=1;micello.maps.infoentrytype.EMAIL=2;micello.maps.infoentrytype.URL=3;micello.maps.infoentrytype.ADDRESS=4;micello.maps.infoentrytype.GENERAL=5;micello.maps.ZList=function(a){this.head={next:null,prev:null,list:a,zi:0};this.iter=null};micello.maps.ZList.prototype.add=function(c){if(c.zi==0){alert("illegal zindex");return}var f=this.head;var b=null;while((f)&&(f.zi<c.zi)){b=f;f=f.next}if((f)&&(f.zi==c.zi)){f.list.push(c)}else{var a={next:f,prev:b,list:[c],zi:c.zi};if(b!=null){b.next=a}else{this.head=a}if(f!=null){f.prev=a}}};micello.maps.ZList.prototype.remove=function(f,b){var j=this.head;var g;var a;var c;while(j){if(j.zi!=0){g=j.list;for(a=0;a<g.length;a++){c=g[a][b];if(f==c){var h=g[a];g.splice(a,1);return h}}}j=j.next}return null};micello.maps.ZList.prototype.start=function(){this.iter=this.head};micello.maps.ZList.prototype.currentList=function(){if(this.iter){return this.iter.list}else{return null}};micello.maps.ZList.prototype.currentZi=function(){if(this.iter){return this.iter.zi}else{return null}};micello.maps.ZList.prototype.next=function(){if(this.iter){this.iter=this.iter.next}};micello.maps.ThemeMap=function(a){this.mapEvent=a;this.NONE_LABEL_TYPE=0;this.TEXT_LABEL_TYPE=1;this.ICON_LABEL_TYPE=2;this.IMAGE_LABEL_TYPE=3;this.ICON_LOOKUP_BASE="icon:";this.IMAGE_LOOKUP_BASE="image:";this.styleTree=null;this.labelTree=null;this.styleMap=null;this.iconMap=null;this.markerMap=null;this.stringsTable=null;this.themeMapUrl=null;this.themeUrl=null;this.stringsUrl=null;this.fontFamilies="arial";this.loaded=false;this.defaultStyle=null};micello.maps.ThemeMap.prototype.isLoaded=function(){return this.loaded};micello.maps.ThemeMap.prototype.setThemeMapUrl=function(a){this.themeMapUrl=a};micello.maps.ThemeMap.prototype.setThemeMapName=function(a){this.themeMapUrl=micello.maps.HOST_URL+"/meta/thememap/v5/"+a};micello.maps.ThemeMap.prototype.setThemeUrl=function(a){this.themeUrl=a};micello.maps.ThemeMap.prototype.setThemeName=function(a){this.themeUrl=micello.maps.HOST_URL+"/meta/theme/v5/"+a};micello.maps.ThemeMap.prototype.setStringsUrl=function(a){this.stringsUrl=a};micello.maps.ThemeMap.prototype.setStringsName=function(a){this.stringsUrl=micello.maps.HOST_URL+"/meta/strings/v5/sdk/"+a};micello.maps.ThemeMap.prototype.loadData=function(){var a=this;if(this.themeMapUrl){var f=function(g){a.onThemeMapLoad(g)};micello.maps.request.loadDataObject(this.themeMapUrl,f)}if(this.themeUrl){var c=function(g){a.onThemeLoad(g)};micello.maps.request.loadDataObject(this.themeUrl,c)}if(this.stringsUrl){var b=function(g){a.onStringsLoad(g)};micello.maps.request.loadDataObject(this.stringsUrl,b)}};micello.maps.ThemeMap.prototype.getFontFamilies=function(){return this.fontFamilies};micello.maps.ThemeMap.prototype.getStyle=function(a){if((this.styleMap==null)||(a==null)){return null}var b=this.styleMap[a];if(!b){b=this.defaultStyle}return b};micello.maps.ThemeMap.prototype.getIcon=function(f,c){if((this.iconMap==null)||(f==null)){return null}var a=this.iconMap[f];if((a)&&(!a.icon)){a.onload=c;var b=function(g){delete a.pending;a.icon=g;if(a.onload){a.onload(a)}};a.pending=true;micello.maps.request.loadDataObject(a.url,b)}return a};micello.maps.ThemeMap.prototype.getImage=function(a,b){var c=this.imageMap[a];if(!c){c={};c.url=a;this.imageMap[a]=c}if(!c.img){c.onload=b;c.img=new Image();c.img.onload=function(){delete c.pending;c.onload(c)};c.pending=true;c.img.src=c.url}return c};micello.maps.ThemeMap.prototype.getMarker=function(a){if((this.markerMap==null)||(a==null)){return null}return this.markerMap[a]};micello.maps.ThemeMap.prototype.translate=function(g,c){if(this.stringsTable){var f=this.stringsTable[g];if(f){var a;a=f[micello.maps.lang];if(a){return a}if(micello.maps.defaultLang){a=f[micello.maps.defaultLang];if(a){return a}}var b;for(b in f){return f[b]}}}return c};micello.maps.ThemeMap.prototype.convertLabelToText=function(b){if((b)&&(b.lr)){var c;var a;if(b.lt==this.TEXT_LABEL_TYPE){c=b.lr;return c}else{if(b.lt==this.ICON_LABEL_TYPE){a=this.ICON_LOOKUP_BASE+b.lr;c=this.translate(a,b.lr);return c}else{if(b.lt==this.IMAGE_LABEL_TYPE){a=this.IMAGE_LOOKUP_BASE+b.lr;c=this.translate(a,b.lr);return c}else{return null}}}}else{return null}};micello.maps.ThemeMap.prototype.getStyleInfo=function(j){if(this.styleTree==null){return null}var g=j;var h=j.a;var f=j.me;var a;var k;var m;for(var c=0;c<this.styleTree.length;c++){k=this.styleTree[c];if((f)&&(f.length>1)){for(var b=0;b<f.length;b++){a=f[b];m=this.processValueEntry(g,a,h,k,undefined,this.getStyleValue);if(m){return m}}}else{if((f)&&(f.length==1)){a=f[0]}else{a=null}m=this.processValueEntry(g,a,h,k,undefined,this.getStyleValue);if(m){return m}}}return null};micello.maps.ThemeMap.prototype.addThemeMap=function(a){if(!this.styleTree){this.styleTree=[]}if(!this.labelTree){this.labelTree=[]}if(a.label){this.mergeTrees(this.labelTree,a.label)}if(a.style){this.mergeTrees(this.styleTree,a.style)}};micello.maps.ThemeMap.prototype.mergeTrees=function(b,j){var a;var g;var k=0;var f;var h;var c;for(f=0;f<j.length;f++){g=j[f];c=false;while(!c){if(k<b.length){a=b[k];h=a.priority}else{h=Number.MAX_VALUE}if(g.priority<=h){b.splice(k,0,g);c=true;k++}else{k++}}}};micello.maps.ThemeMap.prototype.addTheme=function(k){if(!this.styleMap){this.styleMap={}}if(!this.iconMap){this.iconMap={}}if(!this.markerMap){this.markerMap={}}var j;var b;var a;for(j in k.s){this.styleMap[j]=k.s[j]}for(b in k.i){var g={};g.url=k.iurl+k.i[b];this.iconMap[b]=g}for(a in k.m){this.markerMap[a]=k.m[a]}if(k.ff){var c="";var h;for(var f=0;f<k.ff.length;f++){h=k.ff[f];if(h.indexOf(" ")>=0){h="'"+h+"'"}if(c.length>0){c+=","}c+=h}this.fontFamily=c}this.defaultStyle=this.styleMap.Object};micello.maps.ThemeMap.prototype.addStrings=function(b){if(!this.stringsTable){this.stringsTable={}}var a;for(a in b.translations){this.stringsTable[a]=b.translations[a]}};micello.maps.ThemeMap.prototype.getLabel=function(q){if(this.labelTree==null){return null}var m=q;var n=q.a;var k=q.me;var c;var r;var a=null;for(var g=0;g<this.labelTree.length;g++){r=this.labelTree[g];if((k)&&(k.length>1)){var b=null;var o;var j;var h={};for(var f=0;f<k.length;f++){c=k[f];o="e"+c.id;if(!h[o]){j=this.processValueEntry(null,c,null,r,undefined,this.getLabelValue);b=this.convertLabelToText(j);if((b)&&(b.length>0)){if(!a){a=b}else{a+=LABEL_DELIMITER+b}h[o]=true}}}o="g"+m.id;if(!h[o]){j=this.processValueEntry(m,null,n,r,undefined,this.getLabelValue);b=this.convertLabelToText(j);if((b)&&(b.length>0)){if(!a){a=b}else{a+=LABEL_DELIMITER+b}h[o]=true}}}else{if((k)&&(k.length==1)){c=k[0]}else{c=null}var p=this.processValueEntry(m,c,n,r,undefined,this.getLabelValue);if(p){return p}}}if(a){return{lt:this.TEXT_LABEL_TYPE,lr:a}}return null};micello.maps.ThemeMap.prototype.getGeomLabel=function(f){if(this.labelTree==null){return null}var c=f.a;var b;for(var g=0;g<this.labelTree.length;g++){b=this.labelTree[g];var a=this.processValueEntry(f,null,c,b,undefined,this.getLabelValue);if(a){return a}}return null};micello.maps.ThemeMap.prototype.getEntityLabel=function(c){if(this.labelTree==null){return null}var b;for(var f=0;f<this.labelTree.length;f++){b=this.labelTree[f];var a=this.processValueEntry(null,c,null,b,undefined,this.getLabelValue);if(a){return a}}return null};micello.maps.ThemeMap.prototype.processValueEntry=function(k,h,o,q,n,c){var r;var j=q.ks;if(j!=undefined){var a=j.length;for(var m=0;m<a;m++){var g=j[m];var p;var f=undefined;if((g.gk)&&(k)){p=g.gk;f=k.p[p]}else{if((g.ek)&&(h)){p=g.ek;f=h.p[p]}else{if((g.ak)&&(o)){p=g.ak;if(p==o[0]){f=o[1]}}}}if(f!==undefined){if(g.v){var b=g.v[f];if(b!=undefined){r=this.processValueEntry(k,h,o,b,f,c);if(r!=undefined){return r}}}r=c.call(this,k,h,o,g,f);if(r!=undefined){return r}}}}return c.call(this,k,h,o,q,n);if(r!=undefined){return r}else{return undefined}};micello.maps.ThemeMap.prototype.getStyleValue=function(k,c,b,g,h){var f=g.n;if(f!=undefined){if(f=="<value>"){f=h}var a=g.zmin;var j={};j.name=f;if(a){j.zmin=a}return j}else{return undefined}};micello.maps.ThemeMap.prototype.getLabelValue=function(h,b,m,k,j){var a=k.lt;if(a!=undefined){var g=k.r;if(g=="<value>"){g=j}else{if(g=="<short>"){if(m==null){return undefined}g=micello.maps.createShortAddress(m)}else{if(g=="<long>"){if(m==null){return undefined}g=micello.maps.createLongAddress(m)}else{if(g=="<full>"){if(m==null){return undefined}g=micello.maps.createFullAddress(m)}}}}if(k.trans){g=this.translate(g,g)}var f=k.zmin;var c={};c.lt=a;c.lr=g;if(f){c.zmin=f}return c}else{return undefined}};micello.maps.ThemeMap.prototype.onThemeMapLoad=function(a){this.themeMap=a;var b=micello.copyValue(a);this.addThemeMap(b);this.checkForFinish()};micello.maps.ThemeMap.prototype.onThemeLoad=function(a){this.addTheme(a);this.checkForFinish()};micello.maps.ThemeMap.prototype.onStringsLoad=function(a){this.addStrings(a);this.checkForFinish()};micello.maps.ThemeMap.prototype.checkForFinish=function(){if((!this.styleTree)||(!this.styleMap)||(!this.stringsTable)){return}this.loaded=true;if(this.mapEvent){this.mapEvent.dispatchEvent("themeloaded",this)}};micello.refObject={};micello.refArray=[];micello.copyValue=function(c){var f;if(micello.isObject(c)){f={};for(var b in c){f[b]=micello.copyValue(c[b])}}else{if(micello.isArray(c)){newValue=[];for(var a=0;a<value.length;a++){f[a]=micello.copyValue(c[a])}}else{f=c}}return f};micello.isObject=function(a){if(!a){return false}return(a.constructor==micello.refObject.constructor)};micello.isArray=function(a){if(!a){return false}return(a.constructor==micello.refArray.consturctor)};micello.maps.createShortAddress=function(a){return a[1]};micello.maps.createLongAddress=function(a){return a[0]+" "+a[1]};micello.maps.createFullAddress=function(a){var b;if(a.length==3){b=a[2]+" "}else{b=""}b+=a[0]+" "+a[1];return b};micello.util={};micello.util.resolveId=function(g){var c=null;var f=null;var a=false;var b=0;while(!a){c=this.buildId(b,g);f=document.getElementById(c);if(!f){break}b++}return c};micello.util.buildId=function(a,b){if(a===0){return b}else{return b+"-"+a}};micello.util.countElement=function(g){var c=null;var f=null;var a=false;var b=0;while(!a){c=g;if(b>0){c=c+"-"+b}f=document.getElementById(c);if(!f){break}else{b++}}return b};micello.util.addElem=function(c){var a;if(arguments[1]){a=arguments[1]}else{a="div"}var b=document.createElement(a);if(c){b.setAttribute("id",micello.util.resolveId(c))}return b};micello.util.addClass=function(c,a){var b=typeof a;if(b!=="object"){clsArr=[];clsArr=[a];a=clsArr}for(i=0;i<a.length;i++){if(!micello.util.hasClass(c,a)){c.className+=" "+a[i]}}};micello.util.hasClass=function(b,a){return b.className&&new RegExp("(^|\\s)"+a+"(\\s|$)").test(b.className)};micello.util.removeClass=function(c,a){if(this.hasClass(c,a)){var b=new RegExp("(\\s|^)"+a+"(\\s|$)");c.className=c.className.replace(b,"")}};micello.util.addCss=function(a,b){for(var c in b){if(!b.hasOwnProperty||b.hasOwnProperty(c)){a.style[c]=b[c]}}return a};micello.util.removeCss=function(a,b){for(var c in b){if(!b.hasOwnProperty||b.hasOwnProperty(c)){a.style.removeProperty(c)}}return a};micello.util.inArray=function(a,b){for(i=0;i<a.length;i++){if(b==a[i]){return true}}return false};micello.util.hexCheck=function(a){if(a.charAt(0)!="#"){return"#"+a}return a};micello.util.vendorPrefix=function(){var a=window.getComputedStyle(document.documentElement,""),b=(Array.prototype.slice.call(a).join("").match(/-(moz|webkit|ms)-/)||(a.OLink===""&&["","o"]))[1],c=("WebKit|Moz|MS|O").match(new RegExp("("+b+")","i"))[1];return{dom:c,lowercase:b,css:"-"+b+"-",js:b[0].toUpperCase()+b.substr(1)}};micello.maps.MapGUI=function(g,f,b){this.mapControl=g;this.mapEvent=b;this.outsideContainer=document.getElementById(f);if(!this.outsideContainer){alert("Map container not found");return}this.viewportElement=micello.util.addElem("micello-map");var h=micello.util.countElement("micello-map");this.viewportElement.setAttribute("mn",h);micello.util.addClass(this.viewportElement,"micello_map");micello.util.addCss(this.viewportElement,{position:"relative",display:"block",left:"0px",top:"0px",width:"100%",height:"100%",overflow:"hidden",outline:"0px none #ffffff"});this.viewportElement.setAttribute("tabindex",-1);this.outsideContainer.appendChild(this.viewportElement);this.viewportElement.mapTarget=true;var a=document.createElement("div");micello.util.addCss(a,{position:"absolute",display:"block",left:"0px",top:"0px",overflow:"visible"});micello.maps.MapGUI.detectTransformName(a);a.mapTarget=true;this.viewportElement.appendChild(a);this.mapElement=a;var c=this;this.viewportElement.onmousedown=function(j){c.onMouseDown(j)};this.viewportElement.onmouseup=function(j){c.onMouseUp(j)};this.viewportElement.onmousemove=function(j){c.onMouseMove(j)};this.viewportElement.ontouchstart=function(j){c.onTouchStart(j)};this.viewportElement.ontouchmove=function(j){c.onTouchMove(j)};this.viewportElement.ontouchend=function(j){c.onTouchEnd(j)};this.viewportElement.onkeydown=function(j){c.onKeyDown(j)};this.viewportElement.onkeyup=function(j){c.onKeyUp(j)};this.viewportElement.addEventListener("DOMMouseScroll",function(j){c.onMouseWheel(j)},false);this.viewportElement.addEventListener("mousewheel",function(j){c.onMouseWheel(j)},false);window.onresize=function(){c.onResize()};this.UI_FONT="Arial";this.UI_FONT_FALLBACK="Arial";this.ui=micello.util.addElem("ui-all");micello.util.addClass(this.ui,"ui_all");micello.util.addCss(this.ui,{fontFamily:this.UI_FONT});this.ui.onmousemove=function(j){c.conditionalUI()};this.ui.addEventListener("DOMMouseScroll",function(j){c.onMouseWheel(j)},false);this.ui.addEventListener("mousewheel",function(j){c.onMouseWheel(j)},false);this.viewportElement.appendChild(this.ui);this.UISections=new Array;this.grid=new Array("left top","left center","left bottom","center top","center center","center bottom","right top","right center","right bottom");this.gridDefaults=new Array();this.gridDefaults.name="left top";this.gridDefaults.levels="left top";this.gridDefaults.zoom="center bottom";this.gridDefaults.attribution="left bottom";this.gridDefaults.compass="right top";this.gridDefaults.geo="right bottom";this.ui.name=null;this.NAME_VIEW="conditional";this.NAME_POSITION=this.gridDefaults.name;this.NAME_COLOR="#909090";this.DRAWING_COLOR="#909090";this.DRAWING_BG="#ffffff";this.DRAWING_ACTIVE_BG="#006bb7";this.DRAWING_ACTIVE_COLOR="#ffffff";this.DRAWING_HOVER_BG="#f5f4f4";this.DRAWING_HOVER_COLOR="#909090";this.ui.drawings={};this.ui.zoom=null;this.ZOOM_VIEW="conditional";this.ZOOM_POSITION=this.gridDefaults.zoom;this.ZOOM_COLOR="#909090";this.ZOOM_BG="#ffffff";this.ZOOM_BG_ACTIVE="#006bb7";this.ZOOM_BG_ACTIVE_COLOR="#ffffff";this.ZOOM_HOVER_BG_COLOR="#f2f2f2";this.ZOOM_HOVER_COLOR="#909090";this.ZOOM_DISPLAY="h";this.ui.levels=null;this.LEVELS_VIEW="conditional";this.LEVELS_POSITION=this.gridDefaults.levels;this.LEVELS_COLOR="#909090";this.LEVELS_BG="#ffffff";this.LEVELS_BG_ACTIVE="#006bb7";this.LEVELS_ACTIVE_COLOR="#fff";this.LEVELS_HOVER_BG_COLOR="#f5f4f4";this.LEVELS_HOVER_COLOR="#909090";this.ui.geo=null;this.GEO_VIEW="conditional";this.GEO_SCALE_WIDTH=55;this.GEO_UNITS="standard";this.GEO_POSITION=this.gridDefaults.geo;this.GEO_UNITS_TOGGLE="on";this.GEO_ORIENT_TOGGLE="on";this.ui.attribution=null;this.ATTRIBUTION_POSITION=this.gridDefaults.attribution;this.ui.reg={};this.activePinch=false;this.pinchCenter=null;this.pinchStartDistance=null;this.pinchEndDistance=null;this.pinchScale=null;this.backButton=null;this.backActive=false;this.createMouseShield();this.startX=0;this.startY=0;this.moveX=0;this.moveY=0;this.moveTs=0;this.moveTe=0;this.moveSx=0;this.moveSy=0;this.startPan=false;this.startZoom=false;this.startTarget=null;this.moved=false;this.lastTouch=null;this.conditionalAction=null;this.fadeInterval=new Array;this.fadeItems=new Array;this.heightMarker=new Array;this.widthMarker=new Array;this.data=null;this.view=null;this.mapCanvas=null;this.mapEvent=null};micello.maps.MapGUI.prototype.showLoading=function(){micello.util.addCss(this.viewportElement,{backgroundImage:"url('"+micello.maps.request.LOADING_URL+"')"})};micello.maps.MapGUI.prototype.hideLoading=function(){micello.util.addCss(this.viewportElement,{backgroundImage:"none"})};micello.maps.MapGUI.MOVE_LIMIT=2;micello.maps.MapGUI.CONTROL_ZINDEX=101;micello.maps.MapGUI.POPUP_ZINDEX=110;micello.maps.MapGUI.MIN_THRESHOLD=400;micello.maps.MapGUI.transformName=null;micello.maps.MapGUI.originTransformName=null;micello.maps.MapGUI.detectTransformName=function(a){a.style.webkitTransform="scale(1.0)";if(a.style.cssText.search("-transform")>=0){micello.maps.MapGUI.setCssScale=micello.maps.MapGUI.setWebkitCssScale;micello.maps.MapGUI.setCssOrigin=micello.maps.MapGUI.setWebkitCssOrigin;return}if(a.style.MozTransform==""){micello.maps.MapGUI.setCssScale=micello.maps.MapGUI.setMozCssScale;micello.maps.MapGUI.setCssOrigin=micello.maps.MapGUI.setMozCssOrigin;return}a.style.msTransform="scale(1.0)";if(a.style.cssText.search("transform")>=0){micello.maps.MapGUI.setCssScale=micello.maps.MapGUI.setMsCssScale;micello.maps.MapGUI.setCssOrigin=micello.maps.MapGUI.setMsCssOrigin;return}};micello.maps.MapGUI.prototype.onResize=function(){var c=this.viewportElement.offsetWidth;var a=this.viewportElement.offsetHeight;if((this.mapCanvas.lastViewportHeight!=a)||(this.mapCanvas.lastViewportWidth!=c)){this.mapCanvas.drawMap()}var b=this.data.getCurrentDrawing();this.createUI(b);var f=this.data.getCurrentLevel();this.UILevelsCorrection(f)};micello.maps.MapGUI.prototype.onMouseDown=function(b){var a=b.target;if((!a)||(!a.mapTarget)){return}b.cancelBubble=true;if(b.stopPropogation){b.stopPropogation()}if(!this.view){return}this.startTarget=a;micello.util.addCss(this.shield,{display:"block"});this.startX=b.pageX;this.startY=b.pageY;this.startPan=true;this.startZoom=false;this.moveX=0;this.moveY=0;this.moveTe=0;this.moveSx=0;this.moveSy=0;this.moveTs=0;this.mapCanvas.mapMomentum.killMomentum();this.fadeOut("ui-drawings")};micello.maps.MapGUI.prototype.onMouseUp=function(b){startTarget=null;var a=b.target;if((!a)||(!a.mapTarget)){return}b.cancelBubble=true;if(b.stopPropogation){b.stopPropogation()}micello.util.addCss(this.shield,{display:"none"});if((Math.abs(this.moveX)<=micello.maps.MapGUI.MOVE_LIMIT)&&(Math.abs(this.moveY)<=micello.maps.MapGUI.MOVE_LIMIT)){if(b.target.nodeName=="DIV"||b.target.nodeName=="CANVAS"||b.target.nodeName=="IMG"){startTarget=this.startTarget;this.fireMouseClick()}}else{if(this.startPan===true){this.mapCanvas.mapMomentum.begin(this.mapElement,[this.view.mapXInViewport,this.view.mapYInViewport],[this.moveX,this.moveY],[this.moveSx,this.moveSy],this.moveTe)}}this.startPan=false;this.startZoom=false;this.moved=false;this.startTarget=null};micello.maps.MapGUI.prototype.onMouseOut=function(b){var a=b.target;if((!a)||(!a.mapTarget)){return}b.cancelBubble=true;if(b.stopPropogation){b.stopPropogation()}if(this.moved){this.startPan=false;this.moved=false}};micello.maps.MapGUI.prototype.onMouseMove=function(b){var a=b.target;if((!a)||(!a.mapTarget)){return}b.cancelBubble=true;if(b.stopPropogation){b.stopPropogation()}if(this.startPan){this.view.translate(b.pageX-this.startX,b.pageY-this.startY);this.moveX+=b.pageX-this.startX;this.moveY+=b.pageY-this.startY;if(this.moveTs==0){this.moveTs=Date.now()}this.moveTe=Date.now()-this.moveTs;this.moveSx=Math.abs(this.moveX/this.moveTe*100);this.moveSy=Math.abs(this.moveY/this.moveTe*100);this.startX=b.pageX;this.startY=b.pageY;this.moved=true}this.conditionalUI()};micello.maps.MapGUI.prototype.onTouchStart=function(b){var c=true;var a;for(a=0;a<b.touches.length;a++){if((!b.touches[a].target)||(!b.touches[a].target.mapTarget)){c=false}}if(b.touches.length==1){if(!c){this.startPan=false;this.startZoom=false;return}b.preventDefault();this.startPan=true;this.startZoom=false;this.startX=b.touches[0].clientX;this.startY=b.touches[0].clientY;this.moveX=0;this.moveY=0;this.moveTs=0;this.moveTe=0;this.moveSx=0;this.moveSy=0;this.startTarget=b.touches[0].target;this.moved=false}else{if((b.touches.length==2)&&(c)){this.startPan=false;this.startZoom=true;this.startX=(b.touches[0].clientX+b.touches[1].clientX)/2;this.startY=(b.touches[0].clientY+b.touches[1].clientY)/2;this.moved=false}else{this.startPan=false;this.startZoom=false}}this.mapCanvas.mapMomentum.killMomentum();mapGui.fadeOut("ui-drawings");this.conditionalUI()};micello.maps.MapGUI.prototype.onTouchMove=function(c){if(c.touches.length==2){if(this.activePinch==false){this.pinchCenter=[((c.touches[0].clientX+c.touches[1].clientX)/2),((c.touches[0].clientY+c.touches[1].clientY)/2)];this.pinchStartDistance=Math.sqrt(Math.pow(Math.abs(c.touches[0].clientX-c.touches[1].clientX),2)+Math.pow(Math.abs(c.touches[0].clientY-c.touches[1].clientY),2));this.pinchScale=1;this.activePinch=true}else{this.pinchEndDistance=Math.sqrt(Math.pow(Math.abs(c.touches[0].clientX-c.touches[1].clientX),2)+Math.pow(Math.abs(c.touches[0].clientY-c.touches[1].clientY),2));this.pinchScale=this.pinchEndDistance/this.pinchStartDistance}c.preventDefault();this.zoomCssPreview(this.pinchScale,this.pinchCenter[0],this.pinchCenter[1])}if((!this.startPan)||(c.touches.length!=1)){return}c.preventDefault();var b=c.touches[0].clientX-this.startX;var a=c.touches[0].clientY-this.startY;this.view.translate(b,a);this.moveX+=b;this.moveY+=a;this.startX=c.touches[0].clientX;this.startY=c.touches[0].clientY;if(this.moveTs==0){this.moveTs=Date.now()}this.moveTe=Date.now()-this.moveTs;this.moveSx=Math.abs(this.moveX/this.moveTe*100);this.moveSy=Math.abs(this.moveY/this.moveTe*100);this.moved=true;this.conditionalUI()};micello.maps.MapGUI.prototype.onTouchEnd=function(b){if(this.activePinch==true){this.zoomFromPinch(this.pinchScale,this.pinchCenter[0],this.pinchCenter[1]);this.pinchScale=null;this.activePinch=false}if(b.touches.length>0){return}b.preventDefault();var c=this;startTarget=this.startTarget;if((this.startPan)&&(Math.abs(this.moveX)<=micello.maps.MapGUI.MOVE_LIMIT)&&(Math.abs(this.moveY)<=micello.maps.MapGUI.MOVE_LIMIT)){var a=new Date().getTime();delta=a-this.lastTouch;if(delta<150&&delta>0){this.zoomIn();clearTimeout(action)}else{this.lastTouch=a;action=setTimeout(function(f){c.fireMouseClick();clearTimeout(action)},150)}}if(this.startPan===true){this.mapCanvas.mapMomentum.begin(this.mapElement,[this.view.mapXInViewport,this.view.mapYInViewport],[this.moveX,this.moveY],[this.moveSx,this.moveSy],this.moveTe)}this.startPan=false;this.moved=false;this.startTarget=null;this.lastTouch=a;this.conditionalUI()};micello.maps.MapGUI.prototype.onTouchCancel=function(a){a.preventDefault();this.startPan=false;this.moved=false};micello.maps.MapGUI.prototype.zoomCssPreview=function(j,a,k){var c=a;var b=k;for(var h=this.mapElement;h!=null;h=h.offsetParent){c-=h.offsetLeft;b-=h.offsetTop}var g=100*c/this.mapElement.clientWidth;var f=100*b/this.mapElement.clientHeight;micello.maps.MapGUI.setCssOrigin(this.mapElement,g,f);micello.maps.MapGUI.setCssScale(this.mapElement,j)};micello.maps.MapGUI.prototype.zoomFromPinch=function(f,b,h){var a=0;var g=0;for(var c=this.mapElement;c!=null;c=c.offsetParent){a+=c.offsetLeft;g+=c.offsetTop}zoomScale=f*this.view.getZoom();this.zoomEnhancement(b,h,zoomScale,false);this.view.setZoom(zoomScale,b-a,h-g)};micello.maps.MapGUI.prototype.onKeyDown=function(a){switch(a.keyCode){case 187:a.preventDefault();this.zoomIn();break;case 189:a.preventDefault();this.zoomOut();break;case 40:a.preventDefault();this.view.translate(0,-15);break;case 39:a.preventDefault();this.view.translate(-15,0);break;case 38:a.preventDefault();this.view.translate(0,15);break;case 37:a.preventDefault();this.view.translate(15,0);break;case 80:case 76:a.preventDefault();drawing=this.data.getCurrentDrawing();level=this.data.getCurrentLevel();if(drawing.l.length>1){for(l=0;l<drawing.l.length;l++){if(level.id===drawing.l[l].id){if(a.keyCode===76){if(drawing.l[l-1]!==undefined){this.data.setLevel(drawing.l[l-1])}else{this.data.setLevel(drawing.l[drawing.l.length-1])}}if(a.keyCode===80){if(drawing.l[l+1]!==undefined){this.data.setLevel(drawing.l[l+1])}else{this.data.setLevel(drawing.l[0])}}}}}break;case 68:a.preventDefault();community=this.data.getCommunity();drawing=this.data.getCurrentDrawing();if(community.d.length>1){for(d=0;d<community.d.length;d++){if(drawing.id===community.d[d].id){if(community.d[d+1]!==undefined){this.data.setDrawing(community.d[d+1])}else{this.data.setDrawing(community.d[0])}}}}break}};micello.maps.MapGUI.prototype.onKeyUp=function(a){};micello.maps.MapGUI.prototype.onMouseWheel=function(f){var c=f.target;if(c.parentElement.id=="ui-drawings-list"||c.parentElement.className=="ui_drawing"||c.parentElement.className=="ui_drawing_name"||c.id=="ui-drawings"||c.id=="ui-drawings-container"){mapGui.ui.drwLst.onMouseWheel(f);return}if(c.parentElement.className=="ui_levels_floor_name"){mapGui.ui.levelsFlrs.onMouseWheel(f)}if(c.id=="ui-levels-scroll-container"||c.id=="ui-levels-scroll-button"||c.className=="ui_levels_floor"||c.className.indexOf("ui_levels_floor")!=-1||c.className=="ui_levels_floor_name"||c.parentElement.className=="ui_levels_floor_name"||c.id=="ui-levels-floors-wrapper"){mapGui.ui.levelsFlrs.onMouseWheel(f);return}f.preventDefault();if(!c||c.nodeName.toUpperCase()=="DIV"){return}if(f.detail){f.wheelDelta=-f.detail/3}this.mapCanvas.mapMomentum.killMomentum();currScale=this.view.getZoom();newScale=0;if(f.wheelDelta>0){newScale=currScale*1.25}else{newScale=currScale*0.75}var a=0;var g=0;for(var b=this.mapElement;b!=null;b=b.offsetParent){a+=b.offsetLeft-b.scrollLeft;g+=b.offsetTop-b.scrollTop}this.zoomEnhancement(f.clientX-a,f.clientY-g,newScale,false);this.view.setZoom(newScale,f.clientX-a,f.clientY-g);this.conditionalUI()};micello.maps.MapGUI.prototype.zoomEnhancement=function(f,c,g,h){this.NAME_ENTITY_ENHANCEMENT="off";if(this.NAME_ENTITY_ENHANCEMENT=="off"){return}var m=this.view.canvasToMapX(f,c);var k=this.view.canvasToMapY(f,c);var j=this.data.getCurrentLevel();var n=this.data.getCurrentDrawing();var a=this.data.getCommunity();geomClick=this.mapCanvas.hitCheck(j.g,m,k);if(this.NAME_VIEW!="off"){if(geomClick){if(geomClick.nm){this.ui.name.innerHTML=n.nm+'<div id="ui-entity-enhancement">'+geomClick.nm+"</div>"}else{this.ui.name.innerHTML=n.nm}}else{this.ui.name.innerHTML=n.nm}}if(h&&geomClick){if(g>10){if(geomClick.did){for(var b=0;b<a.d.length;b++){if(a.d[b].id==geomClick.did){this.view.setZoom(2,f,c);mapGui.setDrawing(a.d[b])}}}}}};micello.maps.MapGUI.prototype.fireMouseClick=function(){var a=0;var f=0;this.startTarget=startTarget;for(var b=this.mapElement;b!=null;b=b.offsetParent){a+=b.offsetLeft;f+=b.offsetTop}var c;if(this.startTarget){c=this.startTarget.mapObject}if(this.mapCanvas){this.mapCanvas.clickMouse(this.startX-a,this.startY-f,c)}};micello.maps.MapGUI.prototype.zoomIn=function(){if(this.view){cntrPointX=this.viewportElement.offsetWidth/2-this.view.mapXInViewport;cntrPointY=this.viewportElement.offsetHeight/2-this.view.mapYInViewport;zoomScale=this.view.getZoom();this.zoomEnhancement(cntrPointX,cntrPointY,zoomScale,false);this.view.zoomIn()}};micello.maps.MapGUI.prototype.zoomOut=function(){if(this.view){cntrPointX=this.viewportElement.offsetWidth/2-this.view.mapXInViewport;cntrPointY=this.viewportElement.offsetHeight/2-this.view.mapYInViewport;zoomScale=this.view.getZoom();this.zoomEnhancement(cntrPointX,cntrPointY,zoomScale,false);this.view.zoomOut()}};micello.maps.MapGUI.prototype.setLevel=function(a){if(this.data){this.data.setLevel(a)}};micello.maps.MapGUI.prototype.setDrawing=function(a){if(this.data){if(a!=this.data.getCurrentDrawing()){this.data.setDrawing(a)}}};micello.maps.MapGUI.prototype.createMouseShield=function(){var b=micello.util.addElem(null);this.shield=b;this.viewportElement.appendChild(b);micello.util.addCss(b,{position:"absolute",top:"0px",left:"0px",width:"100%",height:"100%",display:"none",zIndex:999999});b.mapTarget=true;var a=this;b.onmousedown=function(c){a.onMouseDown(c)};b.onmouseup=function(c){a.onMouseUp(c)};b.onmousemove=function(c){a.onMouseMove(c)};b.onmouseout=function(c){a.onMouseOut(c)};b.ontouchstart=function(c){a.onTouchStart(c)};b.ontouchmove=function(c){a.onTouchMove(c)};b.ontouchend=function(c){a.onTouchEnd(c)}};micello.maps.MapGUI.prototype.updateLevel=function(a){this.UILevelsCorrection(a)};micello.maps.MapGUI.prototype.updateDrawing=function(a){this.createUI(a)};micello.maps.MapGUI.prototype.updateCommunity=function(a){};micello.maps.MapGUI.prototype.closeCommunity=function(){this.destroyUI()};micello.maps.MapGUI.setCssScale=null;micello.maps.MapGUI.setCssOrigin=null;micello.maps.MapGUI.setWebkitCssScale=function(a,b){micello.util.addCss(a,{webkitTransform:"scale("+b+")"})};micello.maps.MapGUI.setMozCssScale=function(a,b){micello.util.addCss(a,{MozTransform:"scale("+b+")"})};micello.maps.MapGUI.setMsCssScale=function(a,b){micello.util.addCss(a,{msTransform:"scale("+b+")"})};micello.maps.MapGUI.setWebkitCssOrigin=function(b,c,a){micello.util.addCss(b,{webkitTransformOrigin:c+"% "+a+"%"})};micello.maps.MapGUI.setMozCssOrigin=function(b,c,a){micello.util.addCss(b,{MozTransformOrigin:c+"% "+a+"%"})};micello.maps.MapGUI.setMsCssOrigin=function(b,c,a){micello.util.addCss(b,{msTransformOrigin:c+"% "+a+"%"})};micello.maps.MapGUI.prototype.createUI=function(a){community=this.data.getCommunity();this.UIName(community);this.UIZoom(community);this.UIAttribution(community);this.UILevels(a);this.UIGeo(a,community);this.determinePosition();this.UIDrawings(a)};micello.maps.MapGUI.prototype.destroyUI=function(a){this.removeElement("ui-name");this.removeElement("ui-drawings");this.removeElement("ui-drawings-icon");this.removeElement("ui-zoom");this.removeElement("ui-levels");this.removeElement("ui-attribution");this.removeElement("ui-geo")};micello.maps.MapGUI.prototype.UIGeo=function(g,a){this.removeElement("ui-geo");if(this.GEO_VIEW!="on"&&this.GEO_VIEW!="conditional"){return false}this.ui.geo=micello.util.addElem("ui-geo");micello.util.addClass(this.ui.geo,["ui_geo","ui_element"]);micello.util.addCss(this.ui.geo,{width:"105px",fontFamily:this.UI_FONT+", "+this.UI_FONT_FALLBACK});this.determinePositionArraySetup("geo",this.GEO_POSITION,100,15);this.ui.appendChild(this.ui.geo);this.UIReg("ui-geo",this.GEO_VIEW);this.ui.map_scale=micello.util.addElem("ui_scale");micello.util.addCss(this.ui.map_scale,{borderBottom:"1px solid #999",position:"absolute",bottom:"4px",zIndex:micello.maps.MapGUI.CONTROL_ZINDEX+4});this.ui.map_scale_text=micello.util.addElem("ui-scale-text","p");micello.util.addCss(this.ui.map_scale_text,{color:"#999",fontWeight:"bold",margin:"0px",textAlign:"center"});this.updateMapScale(g);this.ui.map_scale.appendChild(this.ui.map_scale_text);this.ui.geo.appendChild(this.ui.map_scale);if(this.GEO_UNITS_TOGGLE=="on"){micello.util.addCss(this.ui.map_scale,{cursor:"pointer"});var c=this;changeUnits=function(){if(c.GEO_UNITS=="standard"){c.GEO_UNITS="metric"}else{c.GEO_UNITS="standard"}c.updateMapScale(g)};this.ui.map_scale.onclick=function(){changeUnits()};this.ui.map_scale.ontouchstart=function(j){j.preventDefault();changeUnits()}}if(this.view.customView){micello.util.addCss(this.ui.geo,{width:"60px"});return false}if(this.compassCache){this.ui.geo.appendChild(this.compassCache)}else{this.ui.compass=micello.util.addElem("ui-compass","canvas");this.ui.COMPASS_MAX=50;this.ui.compass.width=this.ui.COMPASS_MAX;this.ui.compass.height=this.ui.COMPASS_MAX;micello.util.addCss(this.ui.compass,{styleFloat:"right",cssFloat:"right",position:"relative",bottom:"-10px",zIndex:micello.maps.MapGUI.CONTROL_ZINDEX+4});this.drawCompass(g.ar,this.ui.compass);this.ui.geo.appendChild(this.ui.compass);this.compassCache=this.ui.compass}if(this.GEO_ORIENT_TOGGLE=="on"){micello.util.addCss(this.ui.compass,{cursor:"pointer"});this.ui.compass.title="Change Orientation";var c=this;var b=function(k,j){delete c.compassCache;if(j.northAtTop){j.northAtTop=false}else{j.northAtTop=true}k.setDrawing(k.currentDrawing,k.currentLevel.id)};var h=this.data;var f=this.mapControl.view;this.ui.compass.onclick=function(){b(h,f)};this.ui.compass.ontouchstart=function(j){j.preventDefault();b(h,f)}}};micello.maps.MapGUI.prototype.updateMapScale=function(z){var p=(z.t[1]*0)+(z.t[3]*0)+(z.t[5]);var u=(z.t[0]*0)+(z.t[2]*0)+(z.t[4]);var v=(z.t[1]*z.w)+(z.t[3]*z.h)+(z.t[5]);var s=(z.t[0]*z.w)+(z.t[2]*z.h)+(z.t[4]);var m;var r;var b;var k;switch(this.GEO_UNITS){case"standard":this.ui.map_scale.title="Switch to Metric";m=3959;b=5280;r="ft";k=[1,2,5,10,15,20,25,30,40,50,100,200,500];break;case"metric":this.ui.map_scale.title="Switch to Standard";m=6371;b=1000;r="m";k=[1,3,5,10,20,30,40,50,100];break;default:m=3959;b=5280;r="ft";k=[1,2,5,10,15,20,25,30,40,50,100,200,500]}var n=(Math.PI/180);var q=(v-p)*n;var o=(s-u)*n;var j=p*n;var g=v*n;var y=Math.sin(q/2)*Math.sin(q/2)+Math.sin(o/2)*Math.sin(o/2)*Math.cos(j)*Math.cos(g);var x=2*Math.atan2(Math.sqrt(y),Math.sqrt(1-y));var w=m*x;var f=Math.sqrt(Math.pow(z.w,2)+Math.pow(z.h,2));var h=(((w/f)/this.view.scale)*this.GEO_SCALE_WIDTH)*b;var t=0;for(var y in k){if(h>k[y]){t=k[y];continue}else{break}}if(t==0){micello.util.addCss(this.ui.map_scale,{display:"none"})}else{micello.util.addCss(this.ui.map_scale,{width:(this.GEO_SCALE_WIDTH/(h/t))+"px"});this.ui.map_scale_text.innerHTML=t+""+r}};micello.maps.MapGUI.prototype.drawCompass=function(f,c){var h=c.width/this.ui.COMPASS_MAX;var g=c.getContext("2d");g.translate(c.width/2,c.height/2);var a=new Image();a.src=micello.SCRIPT_URL+"resources/compass_n.png";var j=(this.view.northAtTop)?true:false;a.onload=function(){var b=a.width*h;var m=a.height*h;g.drawImage(a,b/-2,m/-2,b,m);if(!j){g.rotate(-f)}var k=new Image();k.src=micello.SCRIPT_URL+"resources/compass_arrow4.png";k.onload=function(){var n=k.width*h;var o=k.height*h;g.drawImage(k,n/-2,o/-2,n,o)}}};micello.maps.MapGUI.prototype.UIName=function(a){this.removeElement("ui-name");this.removeElement("ui-drawings");this.removeElement("ui-drawings-icon");if(this.NAME_VIEW!="on"&&this.NAME_VIEW!="conditional"){return false}this.ui.NAME_MAX=18;this.ui.NAME_MIN=11;var b=this.viewportElement.clientWidth;this.ui.name=micello.util.addElem("ui-name");micello.util.addClass(this.ui.name,["ui_name","ui_element"]);micello.util.addCss(this.ui.name,{whiteSpace:"pre"});var c=b*0.04;if(c>this.ui.NAME_MAX){c=this.ui.NAME_MAX}if(c<this.ui.NAME_MIN){c=this.ui.NAME_MIN}micello.util.addCss(this.ui.name,{fontSize:c+"px",fontFamily:this.UI_FONT+", "+this.UI_FONT_FALLBACK});this.ui.nameTxt=micello.util.addElem("ui-name-text");micello.util.addClass(this.ui.nameTxt,"ui_name_text");micello.util.addCss(this.ui.nameTxt,{color:this.NAME_COLOR});this.ui.nameTxt.innerHTML=a.p.name;this.ui.name.appendChild(this.ui.nameTxt);if(this.NAME_POSITION=="right top"){micello.util.addCss(this.ui.name,{textAlign:"right"})}this.determinePositionArraySetup("name",this.NAME_POSITION,1,30);this.ui.appendChild(this.ui.name);this.UIReg("ui-name",this.NAME_VIEW)};micello.maps.MapGUI.prototype.UIDrawings=function(p){if(this.NAME_VIEW!="on"&&this.NAME_VIEW!="conditional"){this.ui.DRAWINGS_VIEW="off";return false}var s=this.data;var q=this.data.getCommunity();if(q.d.length<2){this.ui.DRAWINGS_VIEW="off";return false}this.ui.HEIGHTINCREMENT_MAX=50;this.ui.HEIGHTINCREMENT_MIN=40;var r=this.viewportElement.clientHeight;var f;mapGui=this;var o=this.ui;var k=0;var t=Math.round(r*0.05);if(t>this.ui.HEIGHTINCREMENT_MAX){t=this.ui.HEIGHTINCREMENT_MAX}if(t<this.ui.HEIGHTINCREMENT_MIN){t=this.ui.HEIGHTINCREMENT_MIN}if(q.d.length>2){drwShow=t*3}else{drwShow=t*2}var m=30;var n=30;var h=m/2;var u=15;var c=0;var j=this.availSpace(this.NAME_POSITION,"h");var b=this.availSpace(this.NAME_POSITION,"w");var a=false;o=this.ui;micello.util.addCss(this.ui.name,{cursor:"pointer",height:n+"px"});this.ui.drawings=micello.util.addElem("ui-drawings");micello.util.addClass(this.ui.drawings,["ui_drawings","ui_element"]);micello.util.addCss(this.ui.drawings,{top:this.ui.name.offsetTop+n+n*0.25+"px",display:"none",fontFamily:this.UI_FONT+", "+this.UI_FONT_FALLBACK});this.ui.drwCtr=micello.util.addElem("ui-drawings-container");micello.util.addClass(this.ui.drwCtr,["ui_drawings_container","roundTop","roundBottom","ui-shadow"]);if(m+h+this.ui.name.offsetWidth>this.viewportElement.clientWidth-b.taken){drwWidth=this.viewportElement.clientWidth-b.taken}else{drwWidth=(this.ui.name.offsetWidth+m+h)-u}micello.util.addCss(this.ui.drawings,{width:drwWidth+"px",zIndex:micello.maps.MapGUI.CONTROL_ZINDEX+4});micello.util.addCss(this.ui.drwCtr,{width:drwWidth+"px",zIndex:micello.maps.MapGUI.CONTROL_ZINDEX+4});drwLstWidth=drwWidth+"px";this.ui.drwLst=micello.util.addElem("ui-drawings-list");micello.util.addClass(this.ui.drwLst,"ui_drawings_list");micello.util.addCss(this.ui.drwLst,{width:drwLstWidth,zIndex:micello.maps.MapGUI.CONTROL_ZINDEX+3});this.ui.drwLstEventHandler=function(w){f=s.getCommunity();for(var v=0;v<f.d.length;v++){if(w==f.d[v].id){mapGui.fadeOut("ui-drawings");mapGui.setDrawing(f.d[v])}}};drwLstClkEventHandler=function(v){return function(){o.drwLstEventHandler(v)}};drawingItem=null;for(var g=0;g<q.d.length;g++){drawingItem=micello.util.addElem("ui-drawings-"+q.d[g].id);drawingItem.setAttribute("drawing",q.d[g].id);micello.util.addClass(drawingItem,"ui_drawing");micello.util.addCss(drawingItem,{zIndex:micello.maps.MapGUI.CONTROL_ZINDEX+2,height:t+"px",top:k+"px",left:0,width:drwLstWidth,borderBottom:"1px solid #999"});k+=t;if(p.id==q.d[g].id){micello.util.addCss(drawingItem,{backgroundColor:this.DRAWING_ACTIVE_BG,color:this.DRAWING_ACTIVE_COLOR})}else{micello.util.addCss(drawingItem,{backgroundColor:this.DRAWING_BG,color:this.DRAWING_COLOR});drawingItem.onmouseover=function(v){this.style.backgroundColor=mapGui.DRAWING_HOVER_BG;this.style.color=mapGui.DRAWING_HOVER_COLOR};drawingItem.onmouseout=function(v){this.style.backgroundColor=mapGui.DRAWING_BG;this.style.color=mapGui.DRAWING_COLOR}}drawingName=micello.util.addElem(null);drawingName.setAttribute("drawing",q.d[g].id);micello.util.addClass(drawingName,"ui_drawing_name");micello.util.addCss(drawingName,{zIndex:micello.maps.MapGUI.CONTROL_ZINDEX+1,top:t/4+"px",left:"3px"});drawingName.innerHTML=q.d[g].nm;drawingItem.appendChild(drawingName);drawingItem.onclick=drwLstClkEventHandler(q.d[g].id);this.ui.drwLst.appendChild(drawingItem)}micello.util.addCss(this.ui.drawings,{height:drwShow+t+"px",fontSize:this.ui.name.style.fontSize});micello.util.addCss(this.ui.drwCtr,{height:drwShow+"px"});micello.util.addCss(this.ui.drwLst,{height:k+"px"});this.ui.drawings.appendChild(this.ui.drwLst);this.ui.appendChild(this.ui.drawings);this.ui.drwIcn=micello.util.addElem("ui-drawings-icon");micello.util.addClass(this.ui.drwIcn,["ui_element","ui-shadow"]);micello.util.addCss(this.ui.drwIcn,{border:"1px solid #999",backgroundColor:"#fff",width:m+"px",height:n+"px"});this.ui.drwIcnImg=micello.util.addElem(null,"img");this.ui.drwIcnImg.src=micello.SCRIPT_URL+"resources/drawingsIcon.png";micello.util.addCss(this.ui.drwIcnImg,{width:"relative",height:"block",position:"absolute",top:n/2.8+"px",left:m/3.9+"px"});this.ui.drwIcn.appendChild(this.ui.drwIcnImg);drwLstSetHandler=function(){return function(){mapGui.fadeIn("ui-drawings")}};drwAction=setTimeout(function(v){mapGui.ui.drwIcn.ontouchend=drwLstSetHandler();mapGui.ui.name.ontouchend=drwLstSetHandler();mapGui.ui.name.onmouseover=drwLstSetHandler();mapGui.ui.drwIcn.onmouseover=drwLstSetHandler();clearTimeout(drwAction)},200);micello.util.addCss(this.ui.drwIcn,{top:this.ui.name.style.top});if(this.NAME_POSITION=="left top"){micello.util.addCss(this.ui.drwIcn,{left:this.ui.name.offsetLeft+"px"});micello.util.addCss(this.ui.drawings,{left:this.ui.name.offsetLeft+"px"});micello.util.addCss(this.ui.name,{left:this.ui.name.offsetLeft+(m+h)+"px"});if(this.ui.name.offsetWidth+m+h>this.viewportElement.clientWidth-b.taken){micello.util.addCss(this.ui.name,{width:(this.viewportElement.clientWidth-b.taken)-(this.viewportElement.clientWidth*0.025)-(m+h)+"px",whiteSpace:""});micello.util.addCss(this.ui.nameTxt,{width:this.ui.name.style.width})}}if(this.NAME_POSITION=="right top"){micello.util.addCss(this.ui.drwIcn,{left:this.ui.name.offsetLeft+this.ui.name.offsetWidth+h+"px"});micello.util.addCss(this.ui.drawings,{left:this.ui.name.offsetLeft+"px"});micello.util.addCss(this.ui.name,{left:this.ui.name.offsetLeft-(m+h)+"px"});if(this.ui.name.offsetWidth+m+h>this.viewportElement.clientWidth-b.taken){micello.util.addCss(this.ui.name,{width:this.viewportElement.clientWidth-b.taken-(this.viewportElement.clientWidth*0.025)-(m+h)+"px",left:b.taken+"px",whiteSpace:""});micello.util.addCss(this.ui.nameTxt,{width:this.ui.name.style.width});micello.util.addCss(this.ui.drawings,{width:this.ui.name.offsetWidth+m+"px",left:b.taken+"px"});micello.util.addCss(this.ui.drwIcn,{left:this.ui.name.offsetLeft+this.ui.name.offsetWidth+h+"px"})}micello.util.addCss(this.ui.drwCtr,{width:this.ui.drawings.style.width,left:u+"px"});micello.util.addCss(this.ui.drwLst,{width:this.ui.drawings.style.width})}this.ui.drwLst.ondragstart=function(){return false};this.ui.drwLst.onMouseWheel=function(v){v.preventDefault();o=mapGui.ui;if(v.detail){v.wheelDelta=-v.detail/3}if(v.wheelDelta<0){newScale=o.drwLst.offsetTop-t/2}else{newScale=o.drwLst.offsetTop+t/2}micello.util.addCss(o.drwLst,{left:0,top:newScale+"px"});mapGui.UIDrawingListContain(o);mapGui.UIDrawingArrowToggle();mapGui.conditionalUI()};this.ui.drawings.ontouchstart=function(v){v.preventDefault();v.stopPropagation();startPos=v.touches[0].pageY;a=true;c=0};this.ui.drawings.ontouchmove=function(v){if(v.touches.length==1){v.preventDefault();var w=v.touches[0];fingerMoved=startPos-w.pageY;c+=fingerMoved;startPos=w.pageY;micello.util.addCss(o.drwLst,{left:0,top:o.drwLst.offsetTop-fingerMoved+"px"});mapGui.UIDrawingListContain(o);mapGui.UIDrawingArrowToggle();mapGui.conditionalUI()}};this.ui.drawings.ontouchend=function(w){if((a)&&(Math.abs(c)<=micello.maps.MapGUI.MOVE_LIMIT)){var v=w.target.getAttribute("drawing");if(v){o.drwLstEventHandler(v)}}a=false};this.ui.drawings.appendChild(this.ui.drwCtr);this.ui.drwCtr.appendChild(this.ui.drwLst);this.ui.appendChild(this.ui.drwIcn);this.ui.nameTxt.innerHTML=p.nm;this.ui.drawings.currDraw=p.id;this.UIDrawingArrow();this.UIReg("ui-drawings-icon",this.NAME_VIEW);if(this.NAME_VIEW=="conditional"){this.UIReg("ui-drawings","conditional_hidden")}};micello.maps.MapGUI.prototype.UIDrawingListContain=function(a){if(a.drwLst.offsetTop>0){micello.util.addCss(a.drwLst,{top:"0px"})}if((a.drwLst.offsetTop+a.drwLst.offsetHeight)<=(a.drwCtr.offsetTop+a.drwCtr.offsetHeight)){micello.util.addCss(a.drwLst,{top:(a.drwCtr.offsetTop+a.drwCtr.offsetHeight)-a.drwLst.offsetHeight+"px"})}};micello.maps.MapGUI.prototype.UIDrawingArrow=function(){var a=this;var b=this.ui;this.ui.drwArwUp=micello.util.addElem("ui-drawings-arrow-up");micello.util.addCss(this.ui.drwArwUp,{width:lvlArwWdth+"px",top:"0px",height:"40px",display:"none",zIndex:micello.maps.MapGUI.CONTROL_ZINDEX+6});if(this.NAME_POSITION=="right top"){micello.util.addCss(this.ui.drwArwUp,{left:"0px"})}else{micello.util.addCss(this.ui.drwArwUp,{left:drwWidth+"px"})}this.ui.drawings.appendChild(this.ui.drwArwUp);this.ui.drwArwUpImg=micello.util.addElem(null,"img");this.ui.drwArwUpImg.src=micello.SCRIPT_URL+"resources/arrowUp.png";micello.util.addCss(this.ui.drwArwUpImg,{width:"60%",position:"absolute",top:"0px",left:"5px"});this.ui.drwArwUp.appendChild(this.ui.drwArwUpImg);this.ui.drwArwUp.onclick=function(c){newScale=b.drwLst.offsetTop+heightIncrement/2;micello.util.addCss(b.drwLst,{left:0,top:newScale+"px"});a.UIDrawingListContain(b);a.UIDrawingArrowToggle()};this.ui.drwArwDn=micello.util.addElem("ui-drawings-arrow-down");micello.util.addCss(this.ui.drwArwDn,{width:lvlArwWdth+"px",top:drwShow-20+"px",height:"40px",display:"none",zIndex:micello.maps.MapGUI.CONTROL_ZINDEX+6});if(this.NAME_POSITION=="right top"){micello.util.addCss(this.ui.drwArwDn,{left:"0px"})}else{micello.util.addCss(this.ui.drwArwDn,{left:drwWidth+"px"})}this.ui.drawings.appendChild(this.ui.drwArwDn);this.ui.drwArwDnImg=micello.util.addElem(null,"img");this.ui.drwArwDnImg.src=micello.SCRIPT_URL+"resources/arrowDwn.png";micello.util.addCss(this.ui.drwArwDnImg,{width:"60%",height:"60%",position:"absolute",top:"0px",left:"5px"});this.ui.drwArwDn.appendChild(this.ui.drwArwDnImg);this.ui.drwArwDn.onclick=function(c){newScale=b.drwLst.offsetTop-heightIncrement/2;micello.util.addCss(b.drwLst,{top:newScale+"px",left:0});a.UIDrawingListContain(b);a.UIDrawingArrowToggle()};this.UIDrawingArrowToggle()};micello.maps.MapGUI.prototype.UIDrawingArrowToggle=function(){mapGui=this;if(heightManager>drwShow&&(this.ui.drwLst.offsetTop+heightManager)!=(this.ui.drwCtr.offsetTop+this.ui.drwCtr.offsetHeight)){this.UIDrawingCond=setTimeout(function(a){mapGui.fadeIn("ui-drawings-arrow-down");clearTimeout(mapGui.UIDrawingCond)},750)}else{this.UIDrawingCond=setTimeout(function(a){mapGui.fadeOut("ui-drawings-arrow-down");clearTimeout(mapGui.UIDrawingCond)},750)}if(this.ui.drwLst.offsetTop<0){this.UIDrawingCond=setTimeout(function(a){mapGui.fadeIn("ui-drawings-arrow-up");clearTimeout(mapGui.UIDrawingCond)},750)}else{this.UIDrawingCond=setTimeout(function(a){mapGui.fadeOut("ui-drawings-arrow-up");clearTimeout(mapGui.UIDrawingCond)},750)}};micello.maps.MapGUI.prototype.UIZoom=function(b){this.removeElement("ui-zoom");if(this.ZOOM_VIEW!="on"&&this.ZOOM_VIEW!="conditional"){return false}var h=this.ui;var g=this;this.ui.ZOOM_H_MAX_WIDTH=90;this.ui.ZOOM_H_MAX_HEIGHT=45;this.ui.ZOOM_H_MIN_WIDTH=60;this.ui.ZOOM_H_MIN_HEIGHT=30;this.ui.ZOOM_V_MAX_WIDTH=50;this.ui.ZOOM_V_MAX_HEIGHT=80;this.ui.ZOOM_V_MIN_WIDTH=50;this.ui.ZOOM_V_MIN_HEIGHT=60;this.ui.zoom=micello.util.addElem("ui-zoom");micello.util.addClass(this.ui.zoom,["ui_zoom","ui_element","ui-shadow"]);micello.util.addCss(this.ui.zoom,{border:"1px solid "+this.ZOOM_COLOR,backgroundColor:this.ZOOM_BG,whiteSpace:"nowrap",overflow:"hidden"});this.ui.zmIn=micello.util.addElem("ui-zoom-in");micello.util.addClass(this.ui.zmIn,"ui_zoom_in");micello.util.addCss(this.ui.zmIn,{color:this.ZOOM_COLOR,overflow:"hidden",backgroundColor:this.ZOOM_BG});this.ui.zmIn.innerHTML="+";this.ui.zoom.appendChild(this.ui.zmIn);this.ui.zmOut=document.createElement("div");this.ui.zmOut.setAttribute("id",micello.util.resolveId("ui-zoom-out"));this.ui.zmOut.className="ui_zoom_out";this.ui.zmOut.style.color=this.ZOOM_COLOR;this.ui.zmOut.style.backgroundColor=this.ZOOM_BG;this.ui.zmOut.style.overflow="hidden";this.ui.zmOut.innerHTML="-";this.ui.zoom.appendChild(this.ui.zmOut);zmClkStyle=function(m){var k=document.getElementById(m.target.id);micello.util.addCss(k,{backgroundColor:g.ZOOM_BG_ACTIVE,color:g.ZOOM_BG_ACTIVE_COLOR})};zmClkStyleRestore=function(m){var k=document.getElementById(m.target.id);micello.util.addCss(k,{backgroundColor:g.ZOOM_BG,color:g.ZOOM_COLOR})};this.ui.zmIn.onmouseover=function(k){micello.util.addCss(this,{backgroundColor:g.ZOOM_HOVER_BG_COLOR,color:g.ZOOM_HOVER_COLOR})};this.ui.zmIn.onmouseout=function(k){micello.util.addCss(this,{backgroundColor:g.ZOOM_BG,color:g.ZOOM_COLOR})};this.ui.zmIn.onclick=function(m){zmClkStyle(m);g.zoomIn();var k=m;setTimeout(function(){zmClkStyleRestore(k)},500)};this.ui.zmIn.ontouchstart=function(k){k.preventDefault();zmClkStyle(k)};this.ui.zmIn.ontouchend=function(k){k.preventDefault();zmClkStyleRestore(k);g.zoomIn()};this.ui.zmOut.onmouseover=function(k){micello.util.addCss(this,{backgroundColor:g.ZOOM_HOVER_BG_COLOR,color:g.ZOOM_HOVER_COLOR})};this.ui.zmOut.onmouseout=function(k){micello.util.addCss(this,{backgroundColor:g.ZOOM_BG,color:g.ZOOM_COLOR})};this.ui.zmOut.onclick=function(m){zmClkStyle(m);g.zoomOut();var k=m;setTimeout(function(){zmClkStyleRestore(k)},500)};this.ui.zmOut.ontouchstart=function(k){k.preventDefault();zmClkStyle(k)};this.ui.zmOut.ontouchend=function(k){k.preventDefault();zmClkStyleRestore(k);g.zoomOut()};var f=this.viewportElement.clientWidth;var a=this.viewportElement.clientHeight;var c;var j;switch(this.ZOOM_DISPLAY){case"v":j=a*0.35;c=0;if(j>this.ui.ZOOM_V_MAX_HEIGHT){j=this.ui.ZOOM_V_MAX_HEIGHT}if(j<this.ui.ZOOM_V_MIN_HEIGHT){j=this.ui.ZOOM_V_MIN_HEIGHT}c=j/2.55;micello.util.addClass(this.ui.zmIn,"roundTop");micello.util.addCss(this.ui.zmIn,{lineHeight:j/2+"px",width:c+"px",height:j/2+"px",borderBottom:"1px solid "+this.ZOOM_COLOR,fontSize:j/3+"px"});micello.util.addClass(this.ui.zmOut,"roundBottom");micello.util.addCss(this.ui.zmOut,{lineHeight:j/2.25+"px",width:c+"px",height:j/2+"px",fontSize:j/2.5+"px"});micello.util.addClass(this.ui.zoom,["roundBottom","roundTop"]);case"h":default:c=Math.ceil(f*0.25);j=0;if(c>this.ui.ZOOM_H_MAX_WIDTH){c=this.ui.ZOOM_H_MAX_WIDTH}if(c<this.ui.ZOOM_H_MIN_WIDTH){c=this.ui.ZOOM_H_MIN_WIDTH}j=c/4;if(j>this.ui.ZOOM_H_MAX_HEIGHT){j=this.ui.ZOOM_H_MAX_HEIGHT}if(j<this.ui.ZOOM_H_MIN_HEIGHT){j=this.ui.ZOOM_H_MIN_HEIGHT}inoutWidth=c/2;micello.util.addCss(this.ui.zmIn,{lineHeight:j+"px",width:(inoutWidth)+"px",height:j+"px",borderRight:"1px solid "+this.ZOOM_COLOR,fontSize:c/3+"px"});micello.util.addCss(this.ui.zmOut,{lineHeight:(j)-(j*0.13)+"px",width:(inoutWidth)+"px",height:j+"px",fontSize:c/2.5+"px",marginRight:"-2px"});break}totalWidth=c;micello.util.addCss(this.ui.zoom,{width:totalWidth+"px",height:j+"px",});this.determinePositionArraySetup("zoom",this.ZOOM_POSITION,100,15);this.ui.appendChild(this.ui.zoom);this.UIReg("ui-zoom",this.ZOOM_VIEW);return true};micello.maps.MapGUI.prototype.UILevels=function(a){this.removeElement("ui-levels");if(a.l.length==1){return}if(this.LEVELS_VIEW!="on"&&this.LEVELS_VIEW!="conditional"){return false}this.ui.levels=micello.util.addElem("ui-levels");micello.util.addClass(this.ui.levels,["ui_levels","ui_element"]);micello.util.addCss(this.ui.levels,{fontFamily:this.UI_FONT+", "+this.UI_FONT_FALLBACK});var b=this.ui;this.UILevelsLarge(a,b);this.determinePositionArraySetup("levels",this.LEVELS_POSITION,200,15);this.ui.appendChild(this.ui.levels);this.UIReg("ui-levels",this.LEVELS_VIEW)};micello.maps.MapGUI.prototype.UILevelsContain=function(){if(this.ui.levelsFlrs.offsetTop>0){micello.util.addCss(this.ui.levelsFlrs,{top:"0px"})}if((this.ui.levelsFlrs.offsetTop+this.ui.levelsFlrs.offsetHeight)<=(this.ui.levelsWrp.offsetTop+this.ui.levelsWrp.offsetHeight)){micello.util.addCss(this.ui.levelsFlrs,{top:(this.ui.levelsWrp.offsetTop+this.ui.levelsWrp.offsetHeight)-this.ui.levelsFlrs.offsetHeight+"px"})}};micello.maps.MapGUI.prototype.UILevelsCorrection=function(c){var q=this;var f=this.viewportElement;if(this.LEVELS_VIEW!="on"&&this.LEVELS_VIEW!="conditional"){return false}if(!this.ui.levels){return false}var p=this.viewportElement.clientHeight;var b=this.ui.levels.offsetTop;var h=this.ui.levels.offsetHeight;var k=35;var j;var g=f.getElementsByClassName("ui_levels_floor");for(cnt=0;cnt<g.length;cnt++){micello.util.addCss(g[cnt],{backgroundColor:q.LEVELS_BG,color:q.LEVELS_COLOR});micello.util.addClass(g[cnt],"ui_levels_unselected")}element=document.getElementById(q.getId("ui-levels-floor-"+c.id));if(element){micello.util.removeClass(element,"ui_levels_unselected");micello.util.addCss(element,{backgroundColor:q.LEVELS_BG_ACTIVE,color:q.LEVELS_ACTIVE_COLOR})}j=this.availSpace(this.LEVELS_POSITION,"h");var a=(p-b)-(j.taken+j.taken*0.9);if(parseInt(this.ui.levelsFlrs.style.height)>a){var o=(a/2)-(35/2);var n=-(parseInt(element.style.top)-o);if(n>0){n=0}var m=-(parseInt(this.ui.levelsFlrs.style.height)-a);if(n<m){n=m}micello.util.addCss(this.ui.levelsFlrs,{top:n+"px"})}this.conditionalUI();if(a<k*2){a=k*2}if(h>a){lvlFlrH=a;micello.util.addCss(this.ui.levels,{height:lvlFlrH+"px"});micello.util.addCss(this.ui.levelsCtr,{height:lvlFlrH+"px"});micello.util.addCss(this.ui.levelsWrp,{height:lvlFlrH+"px"});micello.util.addCss(this.ui.lvlArwDn,{top:lvlFlrH-20+"px"});this.UILevelArrowToggleCond=setTimeout(function(r){q.UILevelArrowToggle();clearTimeout(q.UILevelArrowToggleCond)},1000)}};micello.maps.MapGUI.prototype.UILevelsLarge=function(x,n){n.LEVELS_V_MAX_WIDTH=50;n.LEVELS_V_MAX_HEIGHT=250;n.LEVELS_V_MIN_WIDTH=50;n.LEVELS_V_MIN_HEIGHT=150;var m=this.viewportElement.clientHeight;var f=m*0.45;var a=0;if(f>n.LEVELS_V_MAX_HEIGHT){f=n.LEVELS_V_MAX_HEIGHT}if(f<n.LEVELS_V_MIN_HEIGHT){f=n.LEVELS_V_MIN_HEIGHT}a=f/4;if(a>n.LEVELS_V_MAX_WIDTH){a=n.LEVELS_V_MAX_WIDTH}if(a<n.LEVELS_V_MIN_WIDTH){a=n.LEVELS_V_MIN_WIDTH}var t=35;var w=0;var b=t*x.l.length;var j=30;var c=j;var h=false;var s=false;var k=false;var g=false;var p=15;var q=this;var o=this.data;var u=null;var n=this.ui;var r=this.viewportElement;micello.util.addCss(n.levels,{width:a+"px",zIndex:micello.maps.MapGUI.CONTROL_ZINDEX+1});n.levelsCtr=micello.util.addElem("ui-levels-floors-container");micello.util.addClass(n.levelsCtr,"ui_levels_floors_container");micello.util.addCss(n.levelsCtr,{width:c+"px"});n.levels.appendChild(n.levelsCtr);n.levelsWrp=micello.util.addElem("ui-levels-floors-wrapper");micello.util.addClass(n.levelsWrp,["ui_levels_floors_wrapper","roundTop","roundBottom","ui-shadow "]);micello.util.addCss(n.levelsWrp,{width:c+"px",border:"1px solid "+this.LEVELS_COLOR});if(this.LEVELS_POSITION=="right top"){micello.util.addCss(n.levelsWrp,{left:p+"px"})}else{micello.util.addCss(n.levelsWrp,{left:"0px"})}n.levels.appendChild(n.levelsWrp);n.levelsFlrs=micello.util.addElem("ui-levels-floors");micello.util.addClass(n.levelsFlrs,"ui_levels_floors");micello.util.addCss(n.levelsFlrs,{color:this.LEVELS_COLOR,width:c+"px",left:0,top:0,zIndex:micello.maps.MapGUI.CONTROL_ZINDEX+2});n.levelsWrp.appendChild(n.levelsFlrs);n.lvlLstEventHandler=function(z){var y=this.getElementsByClassName("ui_levels_floor");for(cnt=0;cnt<y.length;cnt++){micello.util.addCss(y[cnt],{backgroundColor:q.LEVELS_BG,color:q.LEVELS_COLOR});micello.util.addClass(y[cnt],"ui_levels_unselected")}currDraw=o.getCurrentDrawing();for(cnt=0;cnt<currDraw.l.length;cnt++){element=document.getElementById(q.getId("ui-levels-floor-"+z));if(currDraw.l[cnt].id==z){q.setLevel(currDraw.l[cnt]);micello.util.removeClass(element,"ui_levels_unselected");micello.util.addCss(element,{backgroundColor:q.LEVELS_BG_ACTIVE,color:q.LEVELS_ACTIVE_COLOR})}}};for(cnt=x.l.length-1;cnt>=0;cnt--){floor=micello.util.addElem(this.getId("ui-levels-floor-"+x.l[cnt].id));floor.setAttribute("level",x.l[cnt].id);micello.util.addClass(floor,["ui_levels_floor","ui_levels_unselected"]);micello.util.addCss(floor,{height:t+"px",top:w+"px",backgroundColor:this.LEVELS_BG,width:c+"px"});w+=t;if(cnt!=x.l.length-1){micello.util.addCss(floor,{borderTop:"1px solid #f2f2f2"})}floor.onclick=function(y){n.lvlLstEventHandler(this.getAttribute("level"))};floor.onmouseover=function(y){if(micello.util.hasClass(this,"ui_levels_unselected")){micello.util.addCss(this,{backgroundColor:q.LEVELS_HOVER_BG_COLOR,color:q.LEVELS_HOVER_COLOR})}};floor.onmouseout=function(y){if(micello.util.hasClass(this,"ui_levels_unselected")){micello.util.addCss(this,{backgroundColor:q.LEVELS_BG,color:q.LEVELS_COLOR})}};micello.util.addCss(floor,{zIndex:micello.maps.MapGUI.CONTROL_ZINDEX+3});floorName=micello.util.addElem(this.getId("ui-levels-floor-"+x.l[cnt].id));floorName.setAttribute("level",x.l[cnt].id);micello.util.addClass(floorName,["ui_levels_floor_name"]);micello.util.addCss(floorName,{fontSize:c*0.6+"px"});var v=x.l[cnt].p.name;if(!v){v="z="+x.l[cnt].z}u=v.substring(0,2);floorName.innerHTML=u;if(u.length==1){micello.util.addCss(floorName,{left:c*0.3+"px"})}if(u.length==2){micello.util.addCss(floorName,{left:c*0.15+"px"})}micello.util.addCss(floorName,{top:t*0.25+"px",zIndex:micello.maps.MapGUI.CONTROL_ZINDEX+1});floor.appendChild(floorName);n.levelsFlrs.appendChild(floor)}micello.util.addCss(n.levels,{height:b+"px"});micello.util.addCss(n.levelsCtr,{height:b+"px"});micello.util.addCss(n.levelsFlrs,{height:w+"px"});micello.util.addCss(n.levelsWrp,{height:b+"px"});n.levelsFlrs.onMouseWheel=function(z){z.preventDefault();z.cancelBubble=true;if(z.stopPropogation){z.stopPropogation()}var y=q.ui;if(z.detail){z.wheelDelta=-z.detail/3}btnMove=(t/w)*700;if(z.wheelDelta<0){newLvlScale=y.levelsFlrs.offsetTop-btnMove}else{newLvlScale=y.levelsFlrs.offsetTop+btnMove}micello.util.addCss(y.levelsFlrs,{left:0,top:newLvlScale+"px"});q.UILevelsContain();q.UILevelArrowToggle();q.conditionalUI()};this.ui.levels.ontouchstart=function(y){y.preventDefault();startLvlPos=y.touches[0].pageY;s=true;totalMoved=0};this.ui.levels.ontouchmove=function(y){if(y.touches.length==1){y.preventDefault();var z=y.touches[0];n.levelsFlrs.style.left=0;if(s==true){fingerMoved=startLvlPos-z.pageY;totalMoved+=fingerMoved;startLvlPos=z.pageY;n.levelsFlrs.style.top=n.levelsFlrs.offsetTop-fingerMoved+"px";q.UILevelsContain()}q.UILevelArrowToggle();q.conditionalUI()}};this.ui.levels.ontouchend=function(z){if((s)&&(Math.abs(totalMoved)<=micello.maps.MapGUI.MOVE_LIMIT)){var y=z.target.getAttribute("level");if(y){n.lvlLstEventHandler(y)}}s=false};this.UILevelsArrow(p,j,b,w)};micello.maps.MapGUI.prototype.UILevelsArrow=function(a,h,g,f){var b=this;var c=this.ui;this.ui.lvlArwUp=micello.util.addElem("ui-levels-arrow-up");micello.util.addCss(this.ui.lvlArwUp,{width:a+"px",top:"0px",height:"40px",display:"none",zIndex:micello.maps.MapGUI.CONTROL_ZINDEX+6});if(this.LEVELS_POSITION=="left top"){micello.util.addCss(this.ui.lvlArwUp,{left:h*1.1+"px"})}else{this.ui.lvlArwUp.style.left="0px";micello.util.addCss(this.ui.lvlArwUp,{left:"0px"})}this.ui.levels.appendChild(this.ui.lvlArwUp);this.ui.lvlArwUpImg=micello.util.addElem(null,"img");this.ui.lvlArwUpImg.src=micello.SCRIPT_URL+"resources/arrowUp.png";micello.util.addCss(this.ui.lvlArwUpImg,{width:"60%",position:"absolute",top:"0px",left:"5px"});this.ui.lvlArwUp.appendChild(this.ui.lvlArwUpImg);this.ui.lvlArwUp.onclick=function(j){newScale=c.levelsFlrs.offsetTop+floorHeight/2;micello.util.addCss(c.levelsFlrs,{left:0,top:newScale+"px"});b.UILevelsContain();b.UILevelArrowToggle(f)};this.ui.lvlArwDn=micello.util.addElem("ui-levels-arrow-down");micello.util.addCss(this.ui.lvlArwDn,{width:a+"px",top:g-20+"px",height:"40px",display:"none",zIndex:micello.maps.MapGUI.CONTROL_ZINDEX+6});if(this.LEVELS_POSITION=="left top"){micello.util.addCss(this.ui.lvlArwDn,{left:h*1.1+"px"})}else{micello.util.addCss(this.ui.lvlArwDn,{left:"0px"})}this.ui.levels.appendChild(this.ui.lvlArwDn);this.ui.lvlArwDnImg=micello.util.addElem(null,"img");this.ui.lvlArwDnImg.src=micello.SCRIPT_URL+"resources/arrowDwn.png";micello.util.addCss(this.ui.lvlArwDnImg,{width:"relative",position:"block",top:"0px",left:"5px"});this.ui.lvlArwDn.appendChild(this.ui.lvlArwDnImg);this.ui.lvlArwDn.onclick=function(j){newScale=c.levelsFlrs.offsetTop-floorHeight/2;micello.util.addCss(c.levelsFlrs,{left:0,top:newScale+"px"});b.UILevelsContain();b.UILevelArrowToggle(f,g)};this.UILevelArrowToggle(f,g)};micello.maps.MapGUI.prototype.UILevelArrowToggle=function(b,c){var a=this;if(b>c&&((this.ui.levelsFlrs.offsetTop+b!=this.ui.levelsWrp.offsetTop+this.ui.levelsWrp.offsetHeight))){this.UILevelCondDwnIn=setTimeout(function(f){a.fadeIn("ui-levels-arrow-down");clearTimeout(a.UILevelCondDwnIn)},750)}else{this.UILevelCondDwnOut=setTimeout(function(f){a.fadeOut("ui-levels-arrow-down");clearTimeout(a.UILevelCondDwnOut)},750)}if(this.ui.levelsFlrs.offsetTop<0){this.UILevelCondUpIn=setTimeout(function(f){a.fadeIn("ui-levels-arrow-up");clearTimeout(a.UILevelCondUpIn)},750)}else{this.UILevelCondUpOut=setTimeout(function(f){a.fadeOut("ui-levels-arrow-up");clearTimeout(a.UILevelCondUpOut)},750)}};micello.maps.MapGUI.prototype.UIAttribution=function(a){var c=this.viewportElement.clientWidth;var b;var f;this.ui.ATTR_MAX_WIDTH=110;this.ui.ATTR_MIN_WIDTH=70;b=c*0.15;if(b>this.ui.ATTR_MAX_WIDTH){b=this.ui.ATTR_MAX_WIDTH}if(b<this.ui.ATTR_MIN_WIDTH){b=this.ui.ATTR_MIN_WIDTH}f=b*0.27272727;if(micello.maps.key==this.ui.ATTRIBUTION_KEY){return false}this.removeElement("ui-attribution");this.ui.attribution=micello.util.addElem("ui-attribution");micello.util.addClass(this.ui.attribution,["ui_attribution","ui_element"]);micello.util.addCss(this.ui.attribution,{width:b+"px",height:f+(4*(this.ui.ATTR_MAX_WIDTH/b))+"px",display:"block",cursor:"pointer",visibility:"visible",margin:"0",padding:"0"});this.ui.attribution.image=micello.util.addElem(null,"img");this.ui.attribution.image.src=micello.SCRIPT_URL+"resources/logo.png";micello.util.addCss(this.ui.attribution.image,{width:"100%",height:f+"px",position:"absolute",top:"0",left:"0",visibility:"visible",opacity:".6",display:"block",filter:"alpha(opacity=60)"});micello.util.addClass(this.ui.attribution.image,"ui-logo");this.ui.attribution.image.alt="Micello, Inc";this.ui.attribution.image.onclick=function(g){window.open("http://www.micello.com")};this.ui.attribution.image.ontouchend=function(g){window.open("http://www.micello.com")};this.ui.attribution.appendChild(this.ui.attribution.image);this.determinePositionArraySetup("attribution",this.ATTRIBUTION_POSITION,9999,15);this.ui.appendChild(this.ui.attribution)};micello.maps.MapGUI.prototype.determinePositionArraySetup=function(c,a,g,f){if(this.UISections[a]==undefined){this.UISections[a]=new Array}for(i=0;i<this.UISections[a].length;i++){if(this.UISections[a][i]["item"]==c){return}}var b=new Array;b.item=c;b.weight=g;b.margin=f;this.UISections[a].push(b);this.UISections[a].sort(function(j,h){return j.weight-h.weight})};micello.maps.MapGUI.prototype.determinePosition=function(){var g=this.viewportElement.clientWidth;var b=this.viewportElement.clientHeight;var j=0;var a;var f=15;var h;this.heightMarker=new Array;this.positionExceptions();for(var c=0;c<this.grid.length;c++){tmpPos=this.grid[c];if(!this.heightMarker[tmpPos]){this.heightMarker[tmpPos]=10}if(!this.widthMarker[tmpPos]){this.widthMarker[tmpPos]=10}}for(position in this.UISections){switch(position){case"left top":case"center top":case"right top":case"left center":case"center center":case"right center":for(cnt=0;cnt<this.UISections[position].length;cnt++){j=0;a=this.heightMarker[position];h=this.UISections[position][cnt].item;margin=this.UISections[position][cnt].margin;if(!margin){margin=f}switch(position){case"left top":micello.util.addCss(this.ui[h],{top:a+"px",left:g*0.025+"px"});break;case"left center":j=b/2;j-=j*0.1;micello.util.addCss(this.ui[h],{top:a+j+"px",left:g*0.025+"px"});break;case"center top":micello.util.addCss(this.ui[h],{top:a+"px",left:(g/2)-this.ui[h].offsetWidth/2+"px"});break;case"center center":j=b/2;j-=j*0.1;micello.util.addCss(this.ui[h],{top:(a+j)+"px",left:(g/2)-this.ui[h].offsetWidth/2+"px"});break;case"right top":micello.util.addCss(this.ui[h],{top:a+"px",left:g-this.ui[h].offsetWidth-g*0.025+"px"});break;case"right center":j=b/2;j-=j*0.1;micello.util.addCss(this.ui[h],{top:(a+j)+"px",left:g-this.ui[h].offsetWidth-g*0.025+"px"});break}this.heightMarker[position]+=this.ui[h].offsetHeight+margin;if(this.ui[h].offsetWidth>this.widthMarker[position]){this.widthMarker[position]=this.ui[h].offsetWidth}}break;default:for(cnt=this.UISections[position].length-1;cnt>=0;cnt--){j=0;a=this.heightMarker[position];h=this.UISections[position][cnt].item;margin=this.UISections[position][cnt].margin;if(!margin){margin=f}switch(position){case"left bottom":this.ui[h].style.top=(b-(a+this.ui[h].offsetHeight))+"px";this.ui[h].style.left=g*0.025+"px";break;case"center bottom":this.ui[h].style.top=(b-(a+this.ui[h].offsetHeight))+"px";this.ui[h].style.left=(g/2)-this.ui[h].offsetWidth/2+"px";break;case"right bottom":this.ui[h].style.top=(b-(a+this.ui[h].offsetHeight))+"px";this.ui[h].style.left=g-this.ui[h].offsetWidth-g*0.025+"px";break}this.heightMarker[position]+=this.ui[h].offsetHeight+margin;if(this.ui[h].offsetWidth>this.widthMarker[position]){this.widthMarker[position]=this.ui[h].offsetWidth}}break}}};micello.maps.MapGUI.prototype.positionExceptions=function(){var a;for(position in this.UISections){for(cnt=0;cnt<this.UISections[position].length;cnt++){item=this.UISections[position][cnt].item;switch(item){case"name":if(position!="left top"&&position!="right top"){a=this.UISections[position][cnt];this.UISections[position].splice(cnt,1);this.NAME_POSITION=this.gridDefaults.name;this.determinePositionArraySetup(a.item,this.gridDefaults.name,a.weight,a.margin)}break;case"zoom":if(position=="center center"||!micello.util.inArray(this.grid,position)){a=this.UISections[position][cnt];this.UISections[position].splice(cnt,1);this.ZOOM_POSITION=this.gridDefaults.zoom;this.determinePositionArraySetup(a.item,this.gridDefaults.zoom,a.weight,a.margin)}break;case"levels":if(position!="left top"&&position!="right top"){a=this.UISections[position][cnt];this.UISections[position].splice(cnt,1);this.LEVELS_POSITION=this.gridDefaults.levels;this.determinePositionArraySetup(a.item,this.gridDefaults.levels,a.weight,a.margin)}break;case"attribution":break;case"geo":if(position!="right bottom"&&position!="right top"){a=this.UISections[position][cnt];this.UISections[position].splice(cnt,1);this.GEO_POSITION=this.gridDefaults.geo;this.determinePositionArraySetup(a.item,this.gridDefaults.geo,a.weight,a.margin)}break}}}};micello.maps.MapGUI.prototype.removeElement=function(a){var c=Number(this.viewportElement.getAttribute("mn"));var b=micello.util.buildId(c,a);tobeRemoved=document.getElementById(b);if(tobeRemoved){tobeRemoved.onmouseover=null;tobeRemoved.onclick=null;tobeRemoved.parentNode.removeChild(tobeRemoved)}};micello.maps.MapGUI.prototype.fadeOut=function(b){if(typeof this.fadeItems.out=="undefined"){this.fadeItems.out=new Array}var g=document.getElementById(b);if(!g){return}if(g.style.display=="none"){return}var f="out";var c=this;var a=this.fadeInterval.length;if(!this.fadeItems.out[b]){this.fadeItems.out[b]=true;this.fadeInterval[a]=setInterval(function(){c.UIFade(g,f,a,b)},20)}};micello.maps.MapGUI.prototype.fadeIn=function(b){if(typeof this.fadeItems["in"]=="undefined"){this.fadeItems["in"]=new Array}var g=document.getElementById(b);if(!g){return}if(g.style.display!="none"){return}var f="in";var c=this;micello.util.addCss(g,{opacity:0,filter:"alpha(opacity=0)",display:"block"});var a=this.fadeInterval.length;if(!this.fadeItems["in"][b]){this.fadeItems["in"][b]=true;this.fadeInterval[a]=setInterval(function(){c.UIFade(g,f,a,b)},20)}};micello.maps.MapGUI.prototype.UIFade=function(f,c,a,b){if(typeof this.UIFade.fadeSet=="undefined"){this.UIFade.fadeSet=new Array;this.UIFade.fadeReal=new Array}if(typeof this.UIFade.fadeSet[a]=="undefined"){this.UIFade.fadeSet[a]=0;this.UIFade.fadeReal[a]=1}this.UIFade.fadeSet[a]+=0.1;if(c=="in"){this.UIFade.fadeReal[a]=this.UIFade.fadeSet[a]}if(c=="out"){this.UIFade.fadeReal[a]=this.UIFade.fadeReal[a]-0.1}micello.util.addCss(f,{opacity:this.UIFade.fadeReal[a],filter:"alpha(opacity="+this.UIFade.fadeReal[a]*100+")"});if(this.UIFade.fadeSet[a]>=1){if(c=="in"){micello.util.addCss(f,{display:"block"})}if(c=="out"){micello.util.addCss(f,{display:"none"})}clearInterval(this.fadeInterval[a]);delete this.fadeInterval[a];delete this.fadeItems[c][b];delete this.UIFade.fadeSet[a];delete this.UIFade.fadeReal[a]}};micello.maps.MapGUI.prototype.availSpace=function(c,a){var b=new Array();b.avail=0;b.taken=0;switch(true){case (c=="right top"&&a=="h"):b.avail=this.heightMarker["right top"]-(this.heightMarker["right center"]+this.heightMarker["right bottom"]);b.taken=this.heightMarker["right center"]+this.heightMarker["right bottom"];break;case (c=="left top"&&a=="h"):b.avail=this.heightMarker["left top"]-(this.heightMarker["left center"]+this.heightMarker["left bottom"]);b.taken=this.heightMarker["left center"]+this.heightMarker["left bottom"];break;case (c=="right top"&&a=="w"):b.avail=this.widthMarker["right top"]-(this.widthMarker["center top"]+this.widthMarker["left top"]);b.taken=this.widthMarker["center top"]+this.widthMarker["left top"];break;case (c=="left top"&&a=="w"):b.avail=this.widthMarker["left top"]-(this.widthMarker["center top"]+this.widthMarker["right top"]);b.taken=this.widthMarker["center top"]+this.widthMarker["right top"];break}if(b.avail==undefined){b.avail=0}if(b.taken==undefined){b.taken=0}return b};micello.maps.MapGUI.prototype.error=function(b){var a=this;this.ui.error=document.createElement("div");this.ui.error.setAttribute("id",micello.util.resolveId("ui-error"));this.ui.errorClose=document.createElement("div");this.ui.errorClose.setAttribute("id",micello.util.resolveId("ui-error-close"));this.ui.errorClose.innerHTML="x";this.ui.error.appendChild(this.ui.errorClose);this.ui.errorCloseMsg=document.createElement("div");this.ui.errorCloseMsg.setAttribute("id",micello.util.resolveId("ui-error-mesg"));this.ui.errorCloseMsg.innerHTML=b;this.ui.error.appendChild(this.ui.errorCloseMsg);ui=this.ui;this.ui.errorClose.onclick=function(c){a.fadeOut(ui.error)};this.ui.error.style.display="none";this.viewportElement.appendChild(this.ui.error)};micello.maps.MapGUI.prototype.UIReg=function(a,c){mn=Number(this.viewportElement.getAttribute("mn"));var b=micello.util.buildId(mn,a);this.ui.reg[b]=c};micello.maps.MapGUI.prototype.conditionalUI=function(){var a;var b=this;if(this.conditionalAction){clearTimeout(this.conditionalAction);for(a in this.ui.reg){xChk=document.getElementById(a);if(!xChk){continue}if(this.ui.reg[a]=="conditional"&&xChk.style.display=="none"){this.fadeIn(a)}}}this.conditionalAction=setTimeout(function(c){for(a in b.ui.reg){if(b.ui.reg[a]=="conditional"||b.ui.reg[a]=="conditional_hidden"){b.fadeOut(a)}}clearTimeout(b.conditionalAction)},4000)};micello.maps.MapGUI.prototype.getId=function(a){mn=Number(this.viewportElement.getAttribute("mn"));return micello.util.buildId(mn,a)};micello.maps.MapData=function(f,a,g,c,b){this.mapControl=f;this.view=a;this.mapCanvas=g;this.mapGUI=c;this.mapEvent=b;this.community=null;this.mapVersion=undefined;this.entityVersion=undefined;this.currentDrawing=null;this.ti=null;this.currentLevel=null;this.geomMap=null;this.addrMap=null;this.levelMap=null;this.drawingMap=null;this.groupMap=null;this.event={};this.unloadedMOverlays=[];this.unloadedGOverlays=[];this.unloadedInlays=[];this.nextId=micello.maps.MapData.INITIAL_ID};micello.maps.MapData.DEFAULT_ZINDEX=1;micello.maps.MapData.INITIAL_ID=-1;micello.maps.MapData.DEFAULT_THEME_NAME="General";micello.maps.MapData.prototype.mxyToLatLon=function(f,b){if(!this.ti){return null}var a=f*this.ti.mxToLat+b*this.ti.myToLat+this.ti.lat0;var c=f*this.ti.mxToLon+b*this.ti.myToLon+this.ti.lon0;return[a,c]};micello.maps.MapData.prototype.latLonToMxy=function(b,f){if(!this.ti){return null}b-=this.ti.lat0;f-=this.ti.lon0;var c=b*this.ti.latToMx+f*this.ti.lonToMx;var a=b*this.ti.latToMy+f*this.ti.lonToMy;return[c,a]};micello.maps.MapData.prototype.getCommunity=function(){return this.community};micello.maps.MapData.prototype.getCurrentDrawing=function(){return this.currentDrawing};micello.maps.MapData.prototype.getCurrentLevel=function(){return this.currentLevel};micello.maps.MapData.prototype.loadCommunity=function(c,j,h,m,g){var f=this;var k=function(n){f.setCommunity(n,j,h);f.mapGUI.hideLoading()};if(this.community){var a=this.currentLevel;this.community=null;this.mapVersion=undefined;this.entityVersion=undefined;this.initCommunity();if(a){this.mapCanvas.updatelevel(null,a)}this.view.updateDrawing(null);this.mapGUI.closeCommunity();this.event.comLoad=1;if(this.mapChanged){this.mapChanged(this.event)}this.event.drawChange=0;this.event.comLoad=0;this.event.drawLoad=0}var b={};b.id=Number(c);this.mapEvent.dispatchEvent("communityLoadBegin",b);this.mapGUI.showLoading();micello.maps.request.loadCommunity(c,k,m,g)};micello.maps.MapData.prototype.setDrawing=function(b,g){if(!b){return}this.currentDrawing=b;this.transformInfo=null;var h=this.currentDrawing.l;this.initTransform();var k;var j=-999999;if(h){var f;var c=h.length;for(f=0;f<c;f++){var a=h[f];if(g){if(a.id==g){k=a;break}}else{if(a.z<0){if(a.z>j){k=a;j=a.z}}else{if((a.z<j)||(j<0)){k=a;j=a.z}}}}}if(!k){micello.maps.onMapError("Display level not found")}this.event.drawChange=1;this.view.updateDrawing(this.currentDrawing);this.mapGUI.updateDrawing(this.currentDrawing);this.mapEvent.dispatchEvent("drawingLoaded",this.currentDrawing);this.setLevel(k)};micello.maps.MapData.prototype.setLevel=function(h){var f=this;var c=this.currentLevel;if(!h.gList){var b=function(j){h.levelGeom=j;f.initLevel(h);f.event.levelGeomLoad=1;f.setLevel(h);f.mapGUI.hideLoading()};this.mapGUI.showLoading();var a=this.currentDrawing.id;var g=this.community.id;micello.maps.request.loadLevelGeom(g,a,h.id,b,this.mapVersion,this.entityVersion);this.currentLevel=null;if(c){this.mapCanvas.updatelevel(this.currentLevel,c)}return}else{this.currentLevel=h;this.mapGUI.updateLevel(this.currentLevel,c);this.mapCanvas.updatelevel(this.currentLevel,c);if(this.mapChanged){this.mapChanged(this.event);this.event.drawChange=0;this.event.comLoad=0;this.event.drawLoad=0}}this.mapEvent.dispatchEvent("levelLoaded",this.currentLevel)};micello.maps.MapData.prototype.addMarkerOverlay=function(g){if(!this.community){return}if(!g.aid){g.aid=this.createId()}var h,c;var a,j;var k=this.community.d;var m;var b=false;var f=false;for(a=0;(a<k.length)&&(!f);a++){h=k[a];m=h.l;for(j=0;(j<m.length)&&(!f);j++){c=m[j];if(c.gList){f=this.addMarkerToLevel(g,c)}else{b=true}}}if((b)&&(!f)){this.unloadedMOverlays.push(g)}};micello.maps.MapData.prototype.removeMarkerOverlay=function(c,p){if(!this.community){return}var m;var a;var g;var j;var k;var f=this.community.d.length;for(var b=0;b<f;b++){m=this.community.d[b];if(m.l){for(var n=0;n<m.l.length;n++){a=m.l[n];g=a.m;if(g){for(var o=0;o<g.length;o++){j=g[o];k=p?j.anm:j.aid;if(k==c){g.splice(o,1);o--;this.mapCanvas.removeMarker(j)}}}}}}var h=0;while(h<this.unloadedMOverlays.length){j=this.unloadedMOverlays[h];k=p?j.anm:j.aid;if(k==c){this.unloadedMOverlays.splice(h,1)}else{h++}}};micello.maps.MapData.prototype.addGeometryOverlay=function(f){if(!this.community){return}if(!f.lid){micello.maps.onMapError("missing overlay level");return}if((!f.zi)||((f.zi>=0)&&(f.zi<1))){f.zi=micello.maps.MapData.DEFAULT_ZINDEX}if(!f.id){f.aid=this.createId();f.id=f.aid}else{if(f.id>micello.maps.MapData.INITIAL_ID){micello.maps.onMapError("Invalid overlay id");return}if(f.id!=f.aid){micello.maps.onMapError("Format error on geometry overlay.");return}var h=this.geomMap[f.id];if(h){this.removeGeometryOverlay(h.aid)}}var g,b;var a,j;var k=this.community.d;var m;var c=false;for(a=0;(a<k.length)&&(!c);a++){g=k[a];m=g.l;for(j=0;(j<m.length)&&(!c);j++){b=m[j];if(b.id==f.lid){if(b.gList){this.placeGeomOverlayOnLevel(f,b)}else{this.unloadedGOverlays.push(f)}c=true}}}};micello.maps.MapData.prototype.removeGeometryOverlay=function(f,q){if(!this.community){return}var n;var b;var p;var k;var g=q?"anm":"aid";var j;var c=this.community.d.length;for(j=0;j<c;j++){n=this.community.d[j];if(n.l){var o;var a=n.l.length;for(o=0;o<a;o++){b=n.l[o];p=b.gList;if(p){do{k=p.remove(f,g);if(k){this.removeFromObjectMap(k,b);this.mapCanvas.invalidateGeom(k,k.lid)}}while(k)}}}}var m;var h;j=0;while(j<this.unloadedGOverlays.length){h=this.unloadedGOverlays[j];m=q?h.anm:h.aid;if(m==f){this.unloadedGOverlays.splice(j,1)}else{j++}}};micello.maps.MapData.prototype.addInlay=function(h){if(!this.community){return}if(!h.id){micello.maps.onMapError("missing inlay id");return}if(!h.aid){h.aid=this.createId()}if(!h.zi){h.zi=micello.maps.MapData.DEFAULT_ZINDEX}var g,c;var a,j;var k=this.community.d;var m;var b=false;var f=false;for(a=0;(a<k.length)&&(!f);a++){g=k[a];m=g.l;for(j=0;(j<m.length)&&(!f);j++){c=m[j];if(c.gList){f=this.addInlayToLevel(h,c)}else{b=true}}}if((b)&&(!f)){this.unloadedInlays.push(h)}};micello.maps.MapData.prototype.removeInlay=function(j,x){if(!this.community){return}var z;var a;var h;var t;var w;var f;var s=this.community.d.length;var r;for(var q=0;q<s;q++){z=this.community.d[q];if(z.l){w=z.l.length;for(var n=0;n<w;n++){a=z.l[n];r=a.gList;if(r){for(r.start();((h=r.currentList())!=null);r.next()){f=h.length;for(var p=0;p<f;p++){t=h[p];var c=t.inlayList;if(c){var o;var m;var g;var v=false;for(o=c.length-1;o>0;o--){var b=c[o];var k=b.inlay;if(x){m=k.anm==j}else{m=k.aid==j}if(m){c.splice(o,1);g=o;v=true}}if(v){this.updateInlayList(t,g);this.mapCanvas.invalidateGeom(t,a.id)}}}}}}}}var u=0;var y;var k;while(u<this.unloadedInlays.length){k=this.unloadedInlays[u];y=x?k.anm:k.aid;if(y==j){this.unloadedInlays.splice(u,1)}else{u++}}};micello.maps.MapData.prototype.removeAnnotation=function(a){this.removeInlay(a,true);this.removeGeometryOverlay(a,true);this.removeMarkerOverlay(a,true)};micello.maps.MapData.prototype.setCommunity=function(a,b,h){if(a==null){micello.maps.onMapError("null community!");return}this.community=a;this.mapVersion=this.community.mv;this.entityVersion=this.community.ev;this.initCommunity();var j=a.d;if(j==null){micello.maps.onMapError("no drawings!");return}var c;var g;var f;if(b){f=j.length;for(g=0;g<f;g++){if(j[g].id==b){c=j[g]}}}if(!c){f=j.length;for(g=0;g<f;g++){if(j[g].r){c=j[g]}}}if(!c){micello.maps.onMapError("no root drawing found");this.currentDrawing=null;return}this.event.comLoad=1;this.mapEvent.dispatchEvent("communityloaded",this.community);this.mapGUI.updateCommunity(this.community);this.setDrawing(c,h)};micello.maps.MapData.prototype.addMarkerToLevel=function(c,k){var h;var a;var b;var f;var j=false;if(!c.lid){if(!c.iso){b=k.groupMap[c.id]}if(b){for(a=0;a<b.length;a++){h=b[a];f=this.getCopy(c);f.id=h.id;f.lid=null;this.loadLocationFromGeomAndLevel(f,h,k)}}else{h=k.geomMap[c.id];if(h){f=c;this.loadLocationFromGeomAndLevel(f,h,k);j=true}}}else{if(k.id==c.lid){f=c;j=true}}if((f)&&(f.lid)){this.placeMarkerOnLevel(f,k)}return j};micello.maps.MapData.prototype.loadLocationFromGeomAndLevel=function(a,b,c){if((b.mx)&&(b.my)){a.mx=b.mx;a.my=b.my}else{return}a.lid=c.id};micello.maps.MapData.prototype.placeMarkerOnLevel=function(a,b){if(!b.m){b.m=[a]}else{b.m.push(a)}this.mapCanvas.addMarker(a)};micello.maps.MapData.prototype.addInlayToLevel=function(h,k){var f;var a;var c;var b;var j=false;if(!h.iso){c=k.groupMap[h.id]}if(c){for(a=0;a<c.length;a++){f=c[a];b=this.getCopy(h);b.id=f.id;this.addIndividualInlay(b,f,k)}}else{f=k.geomMap[h.id];if(f){b=h;this.addIndividualInlay(b,f,k);j=true}}return j};micello.maps.MapData.prototype.addIndividualInlay=function(j,h,a){if(!h.inlayList){var k=h.p;if(!k){k={}}h.inlayList=[{props:k}]}var c=h.inlayList;var f;var n;var m=0;for(f=1;f<c.length;f++){n=c[f];if(j.zi<n.inlay.zi){m=f;break}}if(m==0){m=c.length}var b={inlay:j};c.splice(f,0,b);this.updateInlayList(h,m);this.mapCanvas.invalidateGeom(h,a.id)};micello.maps.MapData.prototype.updateInlayList=function(g,j){var b=g.inlayList;var c;var f;var h=b[j-1];var a=h.props;if(j==b.length){c=b[j-1]}else{for(f=j;f<b.length;f++){c=b[f];this.applyInlay(a,c);a=c.props}}g.p=c.props};micello.maps.MapData.prototype.applyInlay=function(a,b){var g;var c;var f=b.inlay;if(f.pr){g=f.pr}else{g=this.getCopy(a)}if(f.po){for(c in f.po){g[c]=f.po[c]}}if(f.pd){for(c=0;c<f.pd.length;c++){delete g[f.pd[c]]}}b.props=g};micello.maps.MapData.prototype.placeGeomOverlayOnLevel=function(a,b){this.addToObjectMap(a,b);b.gList.add(a);this.mapCanvas.invalidateGeom(a,a.lid)};micello.maps.MapData.prototype.getCopy=function(c){var a=new Object();var b;for(b in c){a[b]=c[b]}return a};micello.maps.MapData.prototype.initCommunity=function(){this.currentLevel=null;this.currentDrawing=null;this.geomMap={};this.levelMap={};this.drawingMap={};this.groupMap={};this.unloadedMOverlays=[];this.unloadedGOverlays=[];this.unloadedInlays=[];var c;if((this.community)&&(this.community.d)){var b;var a=this.community.d.length;for(b=0;b<a;b++){c=this.community.d[b];c.community=this.community;this.initDrawing(c)}}};micello.maps.MapData.prototype.initDrawing=function(f){var a;this.drawingMap[f.id]=f;if(f.l){var c;var b=f.l.length;for(c=0;c<b;c++){a=f.l[c];if(a.id){a.drawing=f;this.levelMap[a.id]={l:a,d:f}}}}};micello.maps.MapData.prototype.initEntities=function(f){var g;var b;g=this.drawingMap[f.id];g.entities=f;for(var c=0;c<f.e.length;c++){b=f.e[c];b.g=[]}var a;for(var c=0;c<g.l.length;c++){a=g.l[c];this.matchLevel(a)}};micello.maps.MapData.prototype.matchLevel=function(f){if(!f.gList){return}var c=f.drawing.entities;var a;for(var b=0;b<c.e.length;b++){a=c.e[b];if(a.a){this.entityMatchLookup(a,a.a,f,true)}if(a.ia){this.entityMatchLookup(a,a.ia,f,false)}}};micello.maps.MapData.prototype.entityMatchLookup=function(h,f,b,c){var k;var m;var n;for(var g=0;g<f.length;g++){n=f[g];k=null;m=null;if(n.substr(0,3)==="$id"){var a=n.substr(4);m=b.groupMap[a];k=b.geomMap[a]}else{k=b.addressMap[n]}if(m){for(var o=0;o<m.length;o++){k=m[o];this.entityGeomMatch(h,k,c)}}else{if(k){this.entityGeomMatch(h,k,c)}}}};micello.maps.MapData.prototype.entityGeomMatch=function(b,c,a){if(a){b.g.push(c);if(!c.me){c.me=[]}c.me.push(b)}else{b.ig.push(c);if(!c.ie){c.ie=[]}c.ie.push(b)}this.mapCanvas.invalidateGeom(c)};micello.maps.MapData.prototype.initLevel=function(b){var k;var h=b.levelGeom;var q;if(h){b.gList=new micello.maps.ZList(h.g);b.geomMap={};b.addressMap={};b.groupMap={};var s;var c=h.g.length;for(s=0;s<c;s++){k=h.g[s];this.initShape(k);b.geomMap[k.id]=k;k.lvl=b;if(k.a){var f=micello.maps.createFullAddress(k.a);b.addressMap[f]=k}if(k.gid){q=b.groupMap[k.gid];if(q){q.push(k)}else{q=[k];b.groupMap[k.gid]=q}}}if(b.drawing.entities){this.matchLevel(b)}else{var r=this;var p=function(a){r.initEntities(a)};var o=b.drawing.id;var m=b.drawing.community.id;micello.maps.request.loadDrawingEntity(m,o,p,this.mapVersion,this.entityVersion)}var j;var n;if(this.unloadedMOverlays.length>0){for(j=0;j<this.unloadedMOverlays.length;j++){n=this.unloadedMOverlays[j];this.addMarkerToLevel(n,b)}}if(this.unloadedGOverlays.length>0){for(j=0;j<this.unloadedGOverlays.length;j++){n=this.unloadedGOverlays[j];if(n.lid==b.id){this.placeGeomOverlayOnLevel(n,b)}}}if(this.unloadedInlays.length>0){for(j=0;j<this.unloadedInlays.length;j++){n=this.unloadedInlays[j];this.addInlayToLevel(n,b)}}}};micello.maps.MapData.prototype.initTransform=function(){var c={};var b=this.currentDrawing.t;c.mxToLon=b[0];c.myToLon=b[2];c.mxToLat=b[1];c.myToLat=b[3];c.lon0=b[4];c.lat0=b[5];var a=c.mxToLon*c.myToLat-c.mxToLat*c.myToLon;c.lonToMx=c.myToLat/a;c.lonToMy=-c.mxToLat/a;c.latToMx=-c.myToLon/a;c.latToMy=c.mxToLon/a;this.ti=c};micello.maps.MapData.prototype.initShape=function(a){if(a.st==null){if(a.shp){a.st=2}else{a.st=0}}if(a.gt==null){if(a.st!=0){a.gt=2}else{a.gt=0}}};micello.maps.MapData.prototype.addToObjectMap=function(b,c){if(!b.id){return}this.initShape(b);c.geomMap[b.id]=b;b.lvl=c;if(b.gid){var a=c.groupMap[b.gid];if(a){a.push(b)}else{a=[b];c.groupMap[b.gid]=a}}};micello.maps.MapData.prototype.removeFromObjectMap=function(a,g){if(!a.id){return}delete g.geomMap[a.id];delete a.lvl;if(a.gid){var f=g.groupMap[a.gid];if(f){var b;var c=[];for(b=0;b<f.length;b++){if(f[b]!=ovelay.id){c.push(f[b])}}}if(c.length==0){delete this.groupMap[a.gid]}else{g.groupMap[a.gid]=c}}};micello.maps.MapData.prototype.getGeometryGroupList=function(a){var b=this.geomMap[a];var c=null;if(b){c=b.g}if((c)&&(c.gid)){return this.groupMap[c.gid]}else{return null}};micello.maps.MapData.prototype.createId=function(){return this.nextId--};micello.maps.MapCanvas=function(c,b,a){this.mapControl=c;this.mapEvent=a;this.view=null;this.data=null;this.mapElement=b;this.mapMomentum=new micello.maps.MapMomentum(this);this.tileMap={};this.themeMap=null;this.popups=[];this.onMapClick=null;this.getTheme=micello.maps.request.loadTheme;this.MAP_FONT_CAPS=false;this.MAP_FONT_MIN=9;this.MAP_FONT_MAX=28;this.MIN_TEXT_SCALE=null;this.MAX_TEXT_SCALE=null;this.LABEL_BG_COLOR="#ffffff";this.LABEL_BG_PADDING=3;this.LABEL_BG_MARGIN=3;this.LABEL_BG_RADIUS=3;this.LABEL_BG_STROKE_COLOR="#666666";this.LABEL_BG_SHADOW_COLOR="#666666";this.LABEL_BG_SHADOW_BLUR=3;this.LABEL_BG_SHADOW_XOFF=1;this.LABEL_BG_SHADOW_YOFF=1;this.TILE_SIZE=256;this.DRAW_WAIT=10;this.TILE_FACTOR=2;this.IMAGE_DRAW_WAIT=500;this.SHADOW_COLOR="#333333";this.SHADOW_X=2;this.SHADOW_Y=2;this.SHADOW_BLUR=3;this.minMapX=0;this.minMapY=0;this.maxMapX=0;this.maxMapY=0;this.baseAngleRad=0;this.TEXT_FLIP_BIAS=5*Math.PI/180;this.SQAURE_TOL=0.1;this.MAX_SQAURE=Math.PI/4;this.MIN_SQAURE=-Math.PI/4;this.DELTA_SQAURE=Math.PI/2;this.MAX_RECT=Math.PI/2+this.TEXT_FLIP_BIAS;this.MIN_RECT=-Math.PI/2+this.TEXT_FLIP_BIAS;this.DELTA_RECT=Math.PI};micello.maps.MapCanvas.DEFAULT_MARKER_ZI=1;micello.maps.MapCanvas.prototype.createPopup=function(){var a=new micello.maps.MapPopup(this,this.mapElement,this.view);this.popups.push(a);return a};micello.maps.MapCanvas.prototype.removePopup=function(a){a.setActive(false);var c;var b=this.popups.length;for(c=0;c<b;c++){if(this.popups[c]==a){this.popups.splice(c,1)}}};micello.maps.MapCanvas.prototype.clearRenderCache=function(){var j=this.data.getCommunity();if(j){var k=j.d;for(var b=0;b<k.length;b++){var g=k[b];var m=g.l;for(var h=0;h<m.length;h++){var a=m[h];for(var c in a.geomMap){var f=a.geomMap[c];delete f.renderCache}}}mapCanvas.clearTileCache();mapCanvas.drawMap()}};micello.maps.MapCanvas.prototype.drawMap=function(){micello.maps.asynchDraw.waitDraw(this,this.DRAW_WAIT,this.mapControl.mapName)};micello.maps.MapCanvas.prototype.addMarker=function(a){if(!a.mr){return}var f;if(a.mt==micello.maps.markertype.NAMED){if((this.themeMap)&&(this.themeMap.isLoaded())){f=this.themeMap.getMarker(a.mr);if(f.src.substr(0,4)=="http"){var g=f.src.split(":");f.src=micello.maps.PROTOCOL+":"+g[1]}}}else{if(a.mt==micello.maps.markertype.IMAGE){f=a.mr}}if(f){var b=document.createElement("img");b.src=f.src;b.mapTarget=true;b.mapObject=a;b.id="marker"+a.aid;b.onmousedown=function(h){if(h.preventDefault){h.preventDefault()}};a.cx=0;a.cy=0;if(f.ox!=null){a.ox=f.ox}else{a.ox=0}if(f.oy!=null){a.oy=f.oy}else{a.oy=0}if(a.zi==null){a.zi=micello.maps.MapCanvas.DEFAULT_MARKER_ZI}a.element=b;b.style.position="absolute";b.style.zIndex=a.zi;b.style.top="0px";b.style.left="0px";a.visible=true;var c=this.data.getCurrentLevel();this.updateMarker(a,c);this.mapElement.appendChild(b)}};micello.maps.MapCanvas.prototype.updateMarker=function(c,f){if((!f)||(f.id!=c.lid)){if(c.visible){c.visible=false;c.element.style.display="none"}}else{if(!c.visible){c.visible=true;c.element.style.display="block"}var b=this.view.mapToCanvasX(c.mx,c.my);var a=this.view.mapToCanvasY(c.mx,c.my);if((b!=c.cx)||(a!=c.cy)){c.element.style.left=String(b-c.ox)+"px";c.element.style.top=String(a-c.oy)+"px";c.cx=b;c.cy=a}}};micello.maps.MapCanvas.prototype.removeMarker=function(a){if(a.element){this.mapElement.removeChild(a.element)}delete a.element};micello.maps.MapCanvas.prototype.getMarkerCenterX=function(a){if((!a.ox)||(!a.element)){return Number.NaN}return a.mx-a.ox+a.element.offsetWidth/2};micello.maps.MapCanvas.prototype.getMarkerCenterY=function(a){if((!a.oy)||(!a.element)){return Number.NaN}return a.my-a.oy+a.element.offsetHeight/2};micello.maps.MapCanvas.prototype.updateDomOverlays=function(f,c){var b;var g;var a=this.popups.length;for(b=0;b<a;b++){this.popups[b].update()}if(f){g=f.m;if(g){a=g.length;for(b=0;b<a;b++){this.updateMarker(g[b],f)}}}if(c){g=c.m;if(g){a=g.length;for(b=0;b<a;b++){this.updateMarker(g[b],f)}}}};micello.maps.MapCanvas.prototype.invalidateGeom=function(b,f){delete b.renderCache;if(!b.mm){this.loadGeomMinMax(b)}var c;var g=false;for(var a in this.tileMap){c=this.tileMap[a];if((c.lid==f)&&(!c.invalid)&&(c.mapIntersects(b.mm))){c.invalid=true;if(c.connected){g=true}}}if(g){this.drawMap()}};micello.maps.MapCanvas.prototype.updatelevel=function(b,a){this.updateDomOverlays(b,a);if(b){this.drawMap()}else{this.clearCanvas()}};micello.maps.MapCanvas.prototype.onPan=function(b,a,f,c){if((b<this.minPixX)||(a<this.minPixY)||(f>this.maxPixX)||(c>this.maxPixY)){this.drawMap()}};micello.maps.MapCanvas.prototype.onZoom=function(){this.prepareZoomCache();this.updateDomOverlays(this.data.getCurrentLevel(),null);this.drawMap()};micello.maps.MapCanvas.prototype.prepareZoomCache=function(){if(micello.maps.MapGUI.setCssScale){this.zoomCached=true;var b=this.view.getZoom();for(var a in this.tileMap){c=this.tileMap[a];if(c.connected){c.setZoomCache(b)}}}else{var c;for(var a in this.tileMap){c=this.tileMap[a];if(c.connected){c.disconnect()}}}};micello.maps.MapCanvas.prototype.clearZoomCache=function(){if(micello.maps.MapGUI.setCssScale){this.zoomCached=false;for(var a in this.tileMap){tile=this.tileMap[a];if(tile.zoomCache){tile.clearZoomCache(true)}}}};micello.maps.MapCanvas.prototype.drawMapExe=function(){var r=false;var b=this.data.getCurrentLevel();if(!b){return}var o=this.mapElement.offsetWidth;var g=this.mapElement.offsetHeight;var u=this.view.getViewportWidth();var h=this.view.getViewportHeight();var F=this.view.getViewportX();if(F<0){F=0}var E=this.view.getViewportY();if(E<0){E=0}var f=F+u;if(f>o){f=o}var c=E+h;if(c>g){c=g}var D=Math.floor(F/this.TILE_SIZE);var B=Math.floor(E/this.TILE_SIZE);var C=Math.floor(f/this.TILE_SIZE);var A=Math.floor(c/this.TILE_SIZE);this.minPixX=D*this.TILE_SIZE;this.minPixY=B*this.TILE_SIZE;this.maxPixX=(C+1)*this.TILE_SIZE;this.maxPixY=(A+1)*this.TILE_SIZE;var k=(C-D+1)*(A-B+1)*this.TILE_FACTOR;var H;var G;var m=new Date().getTime();var j=null;var s;var q;var w=null;for(var p=D;p<=C;p++){for(var n=B;n<=A;n++){H=micello.maps.MapTile.getKey(this.view,b.id,p,n);G=this.tileMap[H];if(G){G.timeStamp=m;if(G.zoomCache){G.clearZoomCache(false)}if(G.invalid){if(!j){j=G}}else{if(!G.connected){G.connect()}}}else{s=p;q=n;w=H}}}if((this.zoomCached)&&(!j)&&(!w)){this.clearZoomCache()}var a;var z=null;var t=0;for(var v in this.tileMap){t++;G=this.tileMap[v];if((G.timeStamp<m)&&(!G.zoomCache)){if(G.connected){G.disconnect()}if((!z)||(G.timeStamp<a)){a=G.timeStamp;z=G}}}if(j){this.drawTile(j);r=true}else{if(w!=null){if((!z)||(t<k)){z=new micello.maps.MapTile(this.mapElement,this.TILE_SIZE,this.TILE_SIZE,0)}else{delete this.tileMap[z.key]}z.init(this.view,b.id,s,q);this.tileMap[z.key]=z;this.drawTile(z);r=true}}if(r){this.drawMap()}};micello.maps.MapCanvas.prototype.clearTileCache=function(){for(var a in this.tileMap){var b=this.tileMap[a];b.invalid=true;b.connected=false}};micello.maps.MapCanvas.prototype.clearCanvas=function(){for(var a in this.tileMap){tile=this.tileMap[a];if(tile.connected){tile.disconnect()}}};micello.maps.MapCanvas.prototype.drawTile=function(h){var j=this.data.getCurrentLevel();if((!j)||(j.id!=h.lid)){return}if(this.view.getZoomInt()!=h.zoomInt){return}var b=h.canvas.getContext("2d");if(b){b.clearRect(0,0,h.canvas.width,h.canvas.height);if(this.MIN_TEXT_SCALE!=null){this.MAP_FONT_MIN=this.MIN_TEXT_SCALE*10}if(this.MAX_TEXT_SCALE!=null){this.MAP_FONT_MAX=this.MAX_TEXT_SCALE*10}this.MAP_FONT_MIN=parseInt(this.MAP_FONT_MIN);this.MAP_FONT_MAX=parseInt(this.MAP_FONT_MAX);b.font=this.MAP_FONT_MAX+"px "+this.themeMap.getFontFamilies();b.lineJoin="round";b.lineCap="round";var f=this.view.getM2C();var a=this.view.getC2M();b.translate(-h.elementX,-h.elementY);b.transform(f[0],f[1],f[2],f[3],f[4],f[5]);var c;var g=j.gList;for(g.start();((c=g.currentList())!=null);g.next()){this.render(b,c,h)}b.transform(a[0],a[1],a[2],a[3],a[4],a[5]);b.translate(h.elementX,h.elementY)}h.invalid=false;if(!h.connected){h.connect()}};micello.maps.MapCanvas.prototype.render=function(u,j,y){if((!this.themeMap)||(!this.themeMap.isLoaded())){return}var k=j.length;var r=y.scale;var v;var s;for(v=0;v<k;v++){s=j[v];if(!s.mm){this.loadGeomMinMax(s)}if((s.mm)&&(!y.mapIntersects(s.mm))){continue}if(!s.renderCache){s.renderCache=this.getRenderCache(u,s,y)}var h=s.renderCache;if((h)&&(h.style)){if((h.szmin)&&(h.szmin>r)){continue}this.renderPath(u,s,h.style,r,y)}}for(v=0;v<k;v++){s=j[v];if((s.mm)&&(!y.mapIntersects(s.mm))){continue}var h=s.renderCache;if((!h)||(!h.w)||(!h.h)){continue}if((h.lzmin)&&(h.lzmin>r)){continue}var m=s.l;var g=m[2];var x=m[3];var o=m[4];if(g<=0){g=1}if(x<=0){x=1}var c=this.getScaleFactor(g,x,h.w,h.h);var a=((Math.abs(h.h/h.w-1)<this.SQAURE_TOL)||(Math.abs(x/g-1)<this.SQUARE_TOL));var b=false;if(h.labType==1){var q=c*r;if(q*this.MAP_FONT_MAX<this.MAP_FONT_MIN){continue}if(q>1){c=1/r;b=(h.w*c<x)}}if(b){o=this.baseAngleRad}else{var f=o-this.baseAngleRad;if(a){while(f>this.MAX_SQAURE){f-=this.DELTA_SQAURE;o-=this.DELTA_SQAURE}while(f<this.MIN_SQAURE){f+=this.DELTA_SQAURE;o+=this.DELTA_SQAURE}}else{while(f>this.MAX_RECT){f-=this.DELTA_RECT;o-=this.DELTA_RECT}while(f<this.MIN_RECT){f+=this.DELTA_RECT;o+=this.DELTA_RECT}}}u.translate(m[0],m[1]);u.rotate(o);u.scale(c,c);u.translate(h.nax,h.nay);if(h.textFill){if(h.styleLabel){this.drawLabelBackground(u,h.w,h.h,h.m,h.p,h.styleLabel)}u.fillStyle=h.textFill;u.textAlign="center";u.textBaseline="middle";if(h.labRef2){u.fillText(h.labRef,0,-this.MAP_FONT_MAX/2);u.fillText(h.labRef2,0,this.MAP_FONT_MAX/2)}else{u.fillText(h.labRef,0,0)}}else{if(h.icon){var n;var t=h.icon.g.length;for(n=0;n<t;n++){var p=h.icon.g[n];var w;if(p.os){w=p.os}else{w=this.themeMap.getStyle(p.t)}if(!w){continue}this.renderPath(u,p,w,r)}}else{if(h.img){u.drawImage(h.img,0,0)}}}u.translate(-h.nax,-h.nay);u.scale(1/c,1/c);u.rotate(-o);u.translate(-m[0],-m[1])}};micello.maps.MapCanvas.prototype.getRenderCache=function(C,A,M){var n={};if(A.st==2){var g=this.themeMap.getStyleInfo(A);n.style=this.themeMap.getStyle(g.name);if(g.zmin){n.szmin=g.zmin}}if(A.l){var t=A.l;var j=t[2];var L=t[3];if(j<=0){j=1}if(L<=0){L=1}var z=this.themeMap.getLabel(A);if(z){n.labType=z.lt;n.labRef=z.lr;if(z.zmin){n.lzmin=z.zmin}if(n.labType==1){var g=this.themeMap.getStyleInfo(A);var H=this.themeMap.getStyle(g.name);if((H)&&(H.t)){n.textFill=H.t;n.styleLabel=H.label;if((g.zmin)&&((!n.zmin)||(g.zmin<n.zmin))){n.lzmin=g.zmin}if(this.MAP_FONT_CAPS){n.labRef=n.labRef.toUpperCase()}var f={};var D=C.measureText(n.labRef);var w=D.width;var u=this.MAP_FONT_MAX;var B=0;var y=0;if(n.styleLabel){B=(n.styleLabel.margin!=undefined)?parseInt(n.styleLabel.margin):this.LABEL_BG_MARGIN;y=(n.styleLabel.padding!=undefined)?parseInt(n.styleLabel.padding):this.LABEL_BG_PADDING;w+=(B*2)+(y*2);u+=(B*2)+(y*2)}f={lr:n.labRef,w1:w,h1:u,margin:B,padding:y};var r=n.labRef.length/2;var q=-1;var K;var I=null;var x;var J;while((J=n.labRef.indexOf(" ",q+1))>=0){q=J;K=Math.abs(J-r);if(I){if(K<x){I=q;x=K}}else{I=q;x=K}}if(I){var b=n.labRef.substr(0,I);var a=n.labRef.substr(I+1,n.labRef.length);var G=C.measureText(b).width;var F=C.measureText(a).width;var v=G>F?G:F;var s=2*this.MAP_FONT_MAX;if(n.styleLabel){v+=(B*2)+(y*2);s+=(B*2)+(y*2)}var o=this.getScaleFactor(j,L,w,u);var k=this.getScaleFactor(j,L,v,s);if(k>o){f.sc=1/o;f.sa=b;f.sb=a;f.w2=v;f.h2=s}}n.textCache=f;if(f.sc){n.w=f.w2;n.h=f.h2;n.labRef=f.sa;n.labRef2=f.sb}else{n.w=f.w1;n.h=f.h1}n.m=f.margin;n.p=f.padding;n.nax=0;n.nay=0}}else{if((n.labType==2)||(n.labType==4)){if(n.labType==2){var h=this.themeMap.getIcon(n.labRef,this.updateIcons);if(h.pending){this.addIconTileAndCache(h,M,n)}else{n.icon=h.icon}}else{n.icon=n.labRef}if(n.icon){n.w=n.icon.w;n.h=n.icon.h;n.nax=-n.w/2;n.nay=-n.h/2}}else{if(n.labType==3){var E=this.themeMap.getImage(n.labRef,this.updateImages);if(E.pending){this.addImageTileAndCache(E,M,n)}else{n.img=E.img}if(n.img){n.w=n.img.width;n.h=n.img.height;n.nax=-n.w/2;n.nay=-n.h/2}}}}}}return n};micello.maps.MapCanvas.prototype.getScaleFactor=function(h,b,c,a){var g=h/c;var f=b/a;return(g>f)?f:g};micello.maps.MapCanvas.prototype.drawLabelBackground=function(o,k,f,c,b,n){o.fillStyle=(n.m)?n.m:this.LABEL_BG_COLOR;var a=(n.radius!=undefined)?parseInt(n.radius):this.LABEL_BG_RADIUS;k=k-(c*2);f=f-(c*2);var j=-(k/2)-(b/2);var g=-(f/2)-(b/2);o.beginPath();o.moveTo(j+a,g);o.lineTo(j+(k+b)-a,g);o.quadraticCurveTo(j+(k+b),g,j+(k+b),g+a);o.lineTo(j+(k+b),g+(f+b)-a);o.quadraticCurveTo(j+(k+b),g+(f+b),j+(k+b)-a,g+(f+b));o.lineTo(j+a,g+(f+b));o.quadraticCurveTo(j,g+(f+b),j,g+(f+b)-a);o.lineTo(j,g+a);o.quadraticCurveTo(j,g,j+a,g);o.closePath();if(n.shadow){if(n.shadow==true){o.shadowColor=this.LABEL_BG_SHADOW_COLOR;o.shadowBlur=this.LABEL_BG_SHADOW_BLUR;o.shadowOffsetX=this.LABEL_BG_SHADOW_XOFF;o.shadowOffsetY=this.LABEL_BG_SHADOW_YOFF}else{if(n.shadow==false){o.shadowColor="rgba(0,0,0,0.0)"}else{o.shadowColor=n.shadow[0];o.shadowBlur=n.shadow[1];o.shadowOffsetX=n.shadow[2];o.shadowOffsetY=n.shadow[3]}}}else{o.shadowColor="rgba(0,0,0,0.0)"}o.fill();o.shadowColor="rgba(0,0,0,0.0)";if(n.o){o.strokeStyle=n.o;o.stroke()}};micello.maps.MapCanvas.prototype.renderPath=function(q,k,a,c,g){var m=k.gt;if(m==undefined){m=2}var t=k.gw;var u=k.shp;var o;q.beginPath();var b=u.length;for(var f=0;f<b;f++){o=u[f];switch(o[0]){case 0:q.moveTo(o[1],o[2]);break;case 1:q.lineTo(o[1],o[2]);break;case 2:q.quadraticCurveTo(o[1],o[2],o[3],o[4]);break;case 3:q.bezierCurveTo(o[1],o[2],o[3],o[4],o[5],o[6]);break;case 4:q.closePath();break}}if(m==2){if(a.shadow!=undefined&&a.shadow!=false){var r=a.shadow;if(r===true){q.shadowColor=this.SHADOW_COLOR;q.shadowBlur=this.SHADOW_BLUR*(c*1.5);q.shadowOffsetX=this.SHADOW_X*(c+1);q.shadowOffsetY=this.SHADOW_Y*(c+1)}else{q.shadowColor=r[0];q.shadowBlur=r[1]*(c*2);q.shadowOffsetX=r[2]*(c+1);q.shadowOffsetY=r[3]*(c+1)}}if(a.m!=undefined){q.fillStyle=a.m;q.fill()}q.shadowColor="rgba(0,0,0,0)";if(a.img!=undefined&&a.img!=false){if(!a.pattern&&!a.error){var p={};p.pending=[g];p.img=new Image();var n=this;p.img.onload=function(){n.updateImages(p)};if(a.img==true){p.img.src=micello.maps.HOST_URL+"/webmap/patterns/"+k.t+".png"}else{if(a.img.substr(0,4)){srcTmp=a.img.split(":");finalUrl=micello.maps.PROTOCOL+":"+srcTmp[1]}else{finalUrl=micello.maps.PROTOCOL+"://"+a.img}p.img.src=finalUrl}a.error=false;p.img.onerror=function(s){a.error=true};try{var j=q.createPattern(p.img,"repeat")}catch(h){}a.pattern=j}if(a.pattern){q.fillStyle=a.pattern;q.fill()}}if((a.o!=undefined)&&(a.w)){q.strokeStyle=a.o;q.lineWidth=a.w/c;q.stroke()}}else{if(m==3){if(a.m!=undefined){q.strokeStyle=a.m;q.lineWidth=t;q.stroke()}}else{if(m==1){if((a.m!=undefined)&&(a.w)){q.strokeStyle=a.m;q.lineWidth=a.w/c;q.stroke()}}else{micello.maps.onMapError("other geom type: "+m)}}}};micello.maps.MapCanvas.prototype.clickMouse=function(g,f,a){var k=this.view.canvasToMapX(g,f);var j=this.view.canvasToMapY(g,f);var b=this.data.getCurrentLevel();if(!a){var m;var c;var n=b.gList;for(n.start();((c=n.currentList())!=null);n.next()){m=this.hitCheck(c,k,j);if(m){a=m}}}if(this.onMapClick){this.onMapClick(k,j,a)}var h={};h.x=k;h.y=j;h.clicked=a;this.mapEvent.dispatchEvent("mapClick",h)};micello.maps.MapCanvas.prototype.hitCheck=function(c,m,j){var g=null;var f;var b=c.length;for(f=0;f<b;f++){var h=c[f];var k=h.gt;if((k!=2)&&(k!=0)){continue}if((h.shp)||((h.l)&&((!h.shp)||(h.el)))){if(!h.mm){this.loadGeomMinMax(h)}if((m>h.mm[0][0])&&(j>h.mm[0][1])&&(m<h.mm[1][0])&&(j<h.mm[1][1])){var a=false;if(h.shp){if(micello.geom.pathHit(h.shp,m,j)){a=true}}if((h.l)&&((!h.shp)||(h.el))){if(micello.geom.rotRectHit(h.l,m,j)){a=true}}if(a){g=h}}}}return g};micello.maps.MapCanvas.prototype.updateImages=function(j){var c;var a;var h=j.clientData;if(!h){return}var g=h.mapControl;var f;c=h.infos;if(c){for(a=0;a<c.length;a++){f=c[a];f.img=j.img;f.w=f.img.width;f.h=f.img.height;f.nax=-f.w/2;f.nay=-f.h/2}}var b;c=h.tiles;if(c){for(a=0;a<c.length;a++){b=c[a];b.invalid=true}}delete j.clientData;micello.maps.asynchDraw.waitDraw(g,g.IMAGE_DRAW_WAIT,g.mapControl.mapName)};micello.maps.MapCanvas.prototype.updateIcons=function(b){var f;var a;var j=b.clientData;if(!j){return}var h=j.mapControl;var g;f=j.infos;if(f){for(a=0;a<f.length;a++){g=f[a];g.icon=b.icon;g.w=g.icon.w;g.h=g.icon.h;g.nax=-g.w/2;g.nay=-g.h/2}}var c;f=j.tiles;if(f){for(a=0;a<f.length;a++){c=f[a];c.invalid=true}}delete b.clientData;micello.maps.asynchDraw.waitDraw(h,h.IMAGE_DRAW_WAIT,h.mapControl.mapName)};micello.maps.MapCanvas.prototype.addImagetileAndCache=function(j,c,a){var b;var f;var g;var h=j.clientData;if(!h){h={};h.mapControl=this;h.tiles=[];h.infos=[];j.clientData=h}g=true;if(!h.tiles){h.tiles=[]}f=h.tiles;for(b=0;b<f.length;b++){if(f[b]==c){g=false;break}}if(g){f.push(c)}g=true;if(!h.infos){h.infos=[]}f=h.infos;for(b=0;b<f.length;b++){if(f[b]==a){g=false;break}}if(g){f.push(a)}};micello.maps.MapCanvas.prototype.addIconTileAndCache=function(c,f,a){var b;var g;var h;var j=c.clientData;if(!j){j={};j.mapControl=this;j.tiles=[];j.infos=[];c.clientData=j}h=true;if(!j.tiles){j.tiles=[]}g=j.tiles;for(b=0;b<g.length;b++){if(g[b]==f){h=false;break}}if(h){g.push(f)}h=true;if(!j.infos){j.infos=[]}g=j.infos;for(b=0;b<g.length;b++){if(g[b]==a){h=false;break}}if(h){g.push(a)}};micello.maps.MapCanvas.prototype.check=function(c,a){var b;for(b=0;b<c.length;b++){if(c[b]==a){return}}c.push(a)};micello.maps.MapCanvas.prototype.loadGeomMinMax=function(a){var b=micello.geom.getInvalidMinMax();if(a.shp){micello.geom.loadPathMinMax(a.shp,b)}if((a.l)&&((!a.shp)||(a.el))){micello.geom.loadRotRectMinMax(a.l,b)}a.mm=b};micello.maps.MapCanvas.prototype.arrayContains=function(b,f){var c;for(c=0;c<b.length;c++){if(b[c]==f){return true}}return false};micello.maps.asynchDraw={maps:{},waitDraw:function(c,a,b){var f=this.maps[b];if(!f){f={};f.active=false;this.maps[b]=f}if(!f.active){f.active=true;f.mapCanvas=c;setTimeout("micello.maps.asynchDraw.drawMap('"+b+"')",a)}},drawMap:function(a){var b=this.maps[a];if(!b){return}b.active=false;b.mapCanvas.drawMapExe()}};micello.maps.MapTile=function(b,c,a,f){this.mapElement=b;this.canvas=document.createElement("canvas");this.canvas.style.position="absolute";this.canvas.style.zIndex=f;this.canvas.style.display="none";this.canvas.mapTarget=true;this.mapElement.appendChild(this.canvas);this.width=c;this.height=a;this.canvas.width=c;this.canvas.height=a;this.invalid=true;this.connected=false;this.clearZoomCache(false)};micello.maps.MapTile.prototype.init=function(a,b,f,c){this.lid=b;this.zoomInt=a.getZoomInt();this.tileX=f;this.tileY=c;this.elementX=f*this.width;this.elementY=c*this.height;this.elementMaxX=this.elementX+this.width;this.elementMaxY=this.elementY+this.height;this.setMinMax(a);this.scale=a.getZoom();this.key=micello.maps.MapTile.getKey(a,b,f,c);this.invalid=true;this.connected=false;this.zoomCache=false};micello.maps.MapTile.prototype.setMinMax=function(a){this.minX=a.canvasToMapX(this.elementX,this.elementY);this.minY=a.canvasToMapY(this.elementX,this.elementY);this.maxX=this.minX;this.maxY=this.minY;this.updateMinMax(a,this.elementMaxX,this.elementY);this.updateMinMax(a,this.elementX,this.elementMaxY);this.updateMinMax(a,this.elementMaxX,this.elementMaxY)};micello.maps.MapTile.prototype.updateMinMax=function(f,a,g){var c=f.canvasToMapX(a,g);if(c<this.minX){this.minX=c}if(c>this.maxX){this.maxX=c}var b=f.canvasToMapY(a,g);if(b<this.minY){this.minY=b}if(b>this.maxY){this.maxY=b}};micello.maps.MapTile.getKey=function(a,b,f,c){return b+"|"+a.getZoomInt()+"|"+f+"|"+c};micello.maps.MapTile.prototype.disconnect=function(){this.canvas.style.display="none";this.connected=false};micello.maps.MapTile.prototype.connect=function(){this.canvas.style.left=this.elementX+"px";this.canvas.style.top=this.elementY+"px";this.canvas.style.display="block";this.connected=true};micello.maps.MapTile.prototype.mapIntersects=function(a){return((this.minX<a[1][0])&&(this.minY<a[1][1])&&(this.maxX>a[0][0])&&(this.maxY>a[0][1]))};micello.maps.MapTile.prototype.setZoomCache=function(b){if(micello.maps.MapGUI.setCssScale){this.zoomCache=true;var a=b/this.scale;micello.maps.MapGUI.setCssScale(this.canvas,a);this.canvas.style.left=(a*this.elementX+(a-1)*this.width/2)+"px";this.canvas.style.top=(a*this.elementY+(a-1)*this.width/2)+"px"}};micello.maps.MapTile.prototype.clearZoomCache=function(a){if(micello.maps.MapGUI.setCssScale){this.zoomCache=false;micello.maps.MapGUI.setCssScale(this.canvas,1);if(a){this.disconnect()}}};micello.maps.MapView=function(g,c,b,h,f,a){this.mapControl=g;this.mapCanvas=h;this.mapEvent=a;this.mapGUI=f;this.viewport=c;this.mapElement=b;this.mapXInViewport=0;this.mapYInViewport=0;this.scale=0;this.zoomInt=0;this.setQuantizedScale(1);this.m2c=[1,0,0,1,0,0];this.c2m=[1,0,0,1,0,0];this.baseM2C=[1,0,0,1];this.baseC2M=[1,0,0,1];this.baseOffM=[0,0];this.baseOffC=[0,0];this.northAtTop=false;this.customView=false;this.onViewChange=null;this.event={};this.defaultMapX=0;this.defaultMapY=0;this.defaultW=0;this.defaultH=0;this.drawingSet=false;this.offsetXFraction=0.5;this.offsetYFraction=0.5;this.minWidthFraction=1;this.minHeightFraction=1};micello.maps.MapView.prototype.translate=function(b,a){var f=this.mapXInViewport+b;var c=this.mapYInViewport+a;if((f+this.baseWidth*this.scale<this.viewport.offsetWidth*this.offsetXFraction)||(f>this.viewport.offsetWidth*this.offsetXFraction)||(c+this.baseHeight*this.scale<this.viewport.offsetHeight*this.offsetYFraction)||(c>this.viewport.offsetHeight*this.offsetYFraction)){return}this.mapXInViewport=f;this.mapYInViewport=c;this.mapElement.style.left=this.mapXInViewport+"px";this.mapElement.style.top=this.mapYInViewport+"px";this.mapCanvas.onPan(-this.mapXInViewport,-this.mapYInViewport,-this.mapXInViewport+this.viewport.offsetWidth,-this.mapYInViewport+this.viewport.offsetHeight);if(this.onViewChange){this.event.pan=1;this.event.zoom=0;this.onViewChange(this.event)}var g={};g.minPixX=-this.mapXInViewport;g.minPixY=-this.mapYInViewport;g.maxPixX=-this.mapXInViewport+this.viewport.offsetWidth;g.maxPixY=-this.mapYInViewport+this.viewport.offsetHeight;this.mapEvent.dispatchEvent("pan",g)};micello.maps.MapView.prototype.zoomIn=function(b,a){this.setZoom(this.scale*2,b,a)};micello.maps.MapView.prototype.zoomOut=function(b,a){this.setZoom(this.scale/2,b,a)};micello.maps.MapView.prototype.setZoom=function(b,m,k){if((b*this.baseWidth<this.viewport.offsetWidth*this.minWidthFraction)&&(b*this.baseHeight<this.viewport.offsetHeight*this.minHeightFraction)){var n=this.viewport.offsetWidth*this.minWidthFraction/this.baseWidth;var h=this.viewport.offsetHeight*this.minHeightFraction/this.baseHeight;b=(h<n)?h:n}if(!m){m=this.viewport.offsetWidth*this.offsetXFraction-this.mapXInViewport;k=this.viewport.offsetHeight*this.offsetYFraction-this.mapYInViewport}if(b<=0){b=1}var g=this.scale;this.setQuantizedScale(b);this.setTransformScale();var a=Math.ceil(this.baseWidth*this.scale);var o=Math.ceil(this.baseHeight*this.scale);var f=m*this.scale/g;var c=k*this.scale/g;this.mapXInViewport+=m-f;this.mapYInViewport+=k-c;if(this.mapXInViewport+a<this.viewport.offsetWidth*this.offsetXFraction){this.mapXInViewport=this.viewport.offsetWidth*this.offsetXFraction-a}else{if(this.mapXInViewport>this.viewport.offsetWidth*this.offsetXFraction){this.mapXInViewport=this.viewport.offsetWidth*this.offsetXFraction}}if(this.mapYInViewport+o<this.viewport.offsetHeight*this.offsetYFraction){this.mapYInViewport=this.viewport.offsetHeight*this.offsetYFraction-o}else{if(this.mapYInViewport>this.viewport.offsetHeight*this.offsetYFraction){this.mapYInViewport=this.viewport.offsetHeight*this.offsetYFraction}}micello.maps.MapGUI.setCssOrigin(this.mapElement,0,0);micello.maps.MapGUI.setCssScale(this.mapElement,1);this.mapElement.style.width=a+"px";this.mapElement.style.height=o+"px";this.mapElement.style.left=this.mapXInViewport+"px";this.mapElement.style.top=this.mapYInViewport+"px";this.mapCanvas.onZoom();if(this.mapGUI.MAP_SCALE_VIEW!="off"){this.mapGUI.onResize()}if(this.onViewChange){this.event.pan=0;this.event.zoom=1;this.onViewChange(this.event)}var j={};j.originalScale=g;j.scale=this.scale;j.fixedPointX=f;j.fixedPointY=c;j.mapXInViewport=this.mapXInViewport;j.mapYInViewport=this.mapYInViewport;this.mapEvent.dispatchEvent("zoom",j)};micello.maps.MapView.prototype.setView=function(f,c,b,a){this.defaultMapX=f;this.defaultMapY=c;this.defaultW=b;this.defaultH=a;this.resetView();this.mapCanvas.onZoom();if(this.onViewChange){this.event.pan=0;this.event.zoom=1;this.onViewChange(this.event)}};micello.maps.MapView.prototype.recenter=function(h,g){var f=this.scale*h;var b=this.scale*g;var c=this.viewport.offsetWidth*this.offsetXFraction-this.mapXInViewport;var a=this.viewport.offsetHeight*this.offsetYFraction-this.mapYInViewport;this.translate(c-f,a-b)};micello.maps.MapView.prototype.getZoom=function(){return this.scale};micello.maps.MapView.prototype.getZoomInt=function(){return this.zoomInt};micello.maps.MapView.prototype.home=function(){this.resetView();this.mapCanvas.onZoom();if(this.onViewChange){this.event.pan=0;this.event.zoom=1;this.onViewChange(this.event)}};micello.maps.MapView.prototype.getViewportWidth=function(){return this.viewport.clientWidth};micello.maps.MapView.prototype.getViewportHeight=function(){return this.viewport.clientHeight};micello.maps.MapView.prototype.canvasToMapX=function(b,a){return this.c2m[0]*b+this.c2m[2]*a+this.c2m[4]};micello.maps.MapView.prototype.canvasToMapY=function(b,a){return this.c2m[1]*b+this.c2m[3]*a+this.c2m[5]};micello.maps.MapView.prototype.mapToCanvasX=function(b,a){return this.m2c[0]*b+this.m2c[2]*a+this.m2c[4]};micello.maps.MapView.prototype.mapToCanvasY=function(b,a){return this.m2c[1]*b+this.m2c[3]*a+this.m2c[5]};micello.maps.MapView.prototype.viewportToMapX=function(b,a){return this.canvasToMapX(b-this.mapXInViewport,a-this.mapYInViewport)};micello.maps.MapView.prototype.viewportToMapY=function(b,a){return this.canvasToMapY(b-this.mapXInViewport,a-this.mapYInViewport)};micello.maps.MapView.prototype.getViewportX=function(){return -this.mapXInViewport};micello.maps.MapView.prototype.getViewportY=function(){return -this.mapYInViewport};micello.maps.MapView.prototype.getM2C=function(){return this.m2c};micello.maps.MapView.prototype.getC2M=function(){return this.c2m};micello.maps.MapView.prototype.updateDrawing=function(c){if((c)&&(this.northAtTop)&&(c.ar)){this.setBaseAngRad(-c.ar)}else{if(!this.customView){this.setBaseAngRad(0)}}var f;for(f=0;f<4;f++){this.m2c[f]=this.baseM2C[f];this.c2m[f]=this.baseC2M[f]}this.m2c[4]=0;this.m2c[5]=0;this.c2m[4]=0;this.c2m[5]=0;if(!c){this.baseWidth=0;this.baseHeight=0;this.defaultMapX=0;this.defaultMapY=0;this.defaultW=0;this.defaultH=0;this.drawingSet=false}else{var b=[];b.push([this.mapToCanvasX(c.w,0),this.mapToCanvasY(c.w,0)]);b.push([this.mapToCanvasX(0,c.h),this.mapToCanvasY(0,c.h)]);b.push([this.mapToCanvasX(c.w,c.h),this.mapToCanvasY(c.w,c.h)]);var a=0;var j=0;var h=0;var g=0;for(f=0;f<3;f++){if(a>b[f][0]){a=b[f][0]}if(j>b[f][1]){j=b[f][1]}if(h<b[f][0]){h=b[f][0]}if(g<b[f][1]){g=b[f][1]}}this.baseOffM[0]=-a;this.baseOffM[1]=-j;this.baseWidth=h-a;this.baseHeight=g-j;this.baseOffC[0]=-this.canvasToMapX(-a,-j);this.baseOffC[1]=-this.canvasToMapY(-a,-j);if(c.v){this.defaultMapX=c.v.cx;this.defaultMapY=c.v.cy;this.defaultW=c.v.w;this.defaultH=c.v.h}else{this.defaultMapX=c.w/2;this.defaultMapY=c.h/2;this.defaultW=this.baseWidth;this.defaultH=this.baseHeight}this.drawingSet=true}this.resetView()};micello.maps.MapView.prototype.resetView=function(){if((this.drawingSet)&&(this.defaultW>0)&&(this.defaultH>0)){var c=(this.offsetXFraction>0.5)?2*(1-this.offsetXFraction):2*this.offsetXFraction;var j=(this.offsetYFraction>0.5)?2*(1-this.offsetYFraction):2*this.offsetYFraction;var b=this.viewport.clientWidth*c/this.defaultW;var g=this.viewport.clientHeight*j/this.defaultH;var h=(b>g)?g:b;this.setQuantizedScale(h)}else{this.setQuantizedScale(1)}this.setTransformScale();var f=this.baseWidth*this.scale;var a=this.baseHeight*this.scale;this.mapXInViewport=this.viewport.offsetWidth*this.offsetXFraction-this.mapToCanvasX(this.defaultMapX,this.defaultMapY);this.mapYInViewport=this.viewport.offsetHeight*this.offsetYFraction-this.mapToCanvasY(this.defaultMapX,this.defaultMapY);this.mapElement.style.width=f+"px";this.mapElement.style.height=a+"px";this.mapElement.style.left=this.mapXInViewport+"px";this.mapElement.style.top=this.mapYInViewport+"px"};micello.maps.MapView.prototype.setTransformScale=function(){var a;for(a=0;a<4;a++){this.m2c[a]=this.baseM2C[a]*this.scale;this.c2m[a]=this.baseC2M[a]/this.scale}for(a=0;a<2;a++){this.m2c[4+a]=this.baseOffM[a]*this.scale;this.c2m[4+a]=this.baseOffC[a]}};micello.maps.MapView.SCALE_QUANT=65536;micello.maps.MapView.prototype.setQuantizedScale=function(a){this.zoomInt=Math.floor(a*micello.maps.MapView.SCALE_QUANT);this.scale=this.zoomInt/micello.maps.MapView.SCALE_QUANT};micello.maps.MapView.prototype.setBaseAngRad=function(a){while(a>Math.PI){a-=2*Math.PI}while(a<-Math.PI){a+=2*Math.PI}var f=Math.cos(a);var b=Math.sin(a);this.baseM2C=[f,-b,b,f];this.baseC2M=[f,b,-b,f];this.mapCanvas.baseAngleRad=a};micello.maps.MapView.prototype.setTopNorth=function(a){this.northAtTop=a;this.customView=false};micello.maps.MapView.prototype.setBaseTransform=function(b,c){var a=Math.sqrt(b[0]*b[3]-b[1]*b[2]);this.baseM2C[0]=b[0]/a;this.baseM2C[1]=b[1]/a;this.baseM2C[2]=b[2]/a;this.baseM2C[3]=b[3]/a;this.baseC2M[0]=this.baseM2C[3];this.baseC2M[1]=-this.baseM2C[1];this.baseC2M[2]=-this.baseM2C[2];this.baseC2M[3]=this.baseM2C[0];this.customView=true;this.mapCanvas.baseAngleRad=c};micello.maps.MapPopup=function(c,b,a){this.mapCanvas=c;this.view=a;this.isActive=false;this.isVisible=false;this.containerX=0;this.containerX=0;this.data=null;this.parentElement=b;this.mainDiv=null};micello.maps.MapPopup.MAX_FRACTION=0.6;micello.maps.MapPopup.MAX_WIDTH=300;micello.maps.MapPopup.MAX_HEIGHT=300;micello.maps.MapPopup.INFO_CLOSE_MARGIN=5;micello.maps.MapPopup.MENU_CLOSE_MARGIN=5;micello.maps.MapPopup.prototype.setData=function(a){this.data=a;if(this.mainDiv!=null){this.parentElement.removeChild(this.mainDiv);this.mainDiv=null}if(a.type==micello.maps.popuptype.MENU){this.createMenuPopup(a)}else{if(a.type==micello.maps.popuptype.INFOWINDOW){this.createInfoPopup(a)}}};micello.maps.MapPopup.prototype.exeCmd=function(a){a.func()};micello.maps.MapPopup.prototype.update=function(){var a=this.mapCanvas.data.getCurrentLevel();if((!a)||(!this.isActive)){this.setVisible(false);return}if(this.data){if(a.id!=this.data.lid){this.setVisible(false)}else{this.setVisible(true);var c=this.view.mapToCanvasX(this.data.mapX,this.data.mapY);var b=this.view.mapToCanvasY(this.data.mapX,this.data.mapY);if(this.data.ox){c-=this.data.ox}if(this.data.oy){b-=this.data.oy}var h=this.parentElement.clientHeight;var f=this.parentElement.clientWidth;var k=Math.floor(this.parentElement.clientWidth/2);var j=20;var g=this.parentElement.clientWidth-20;var m=Math.floor(this.mainDiv.clientWidth/2)-5;if((this.containerX!=c)||(this.containerY!=b)){this.mainDiv.style.bottom=String(h-b)+"px";this.mainDiv.style.left=String(c-20)+"px";this.containerX=c;this.containerY=b}}}};micello.maps.MapPopup.prototype.setActive=function(a){this.isActive=a;this.update()};micello.maps.MapPopup.prototype.setVisible=function(a){if(this.isVisible!=a){if(a){this.mainDiv.style.display="block";this.isVisible=true}else{this.mainDiv.style.display="none";this.isVisible=false}}};micello.maps.MapPopup.prototype.createMenuPopup=function(g){var a=this;this.mainDiv=document.createElement("div");this.mainDiv.className="menu";this.mainDiv.style.position="absolute";this.mainDiv.style.zIndex=micello.maps.MapGUI.POPUP_ZINDEX;this.mainDiv.style.bottom="0px";this.mainDiv.style.left="0px";this.containerX=0;this.containerY=0;this.menuWrapperDiv=document.createElement("div");this.menuWrapperDiv.className="menuWrapper";this.mainDiv.appendChild(this.menuWrapperDiv);var n=document.createElement("ul");n.className="menuTable";n.className+=" micello-rounded";n.className+=" micello-pop-shadow";if(g.title){var o=document.createElement("li");o.className="menuTitle";o.innerHTML=g.title;n.appendChild(o);var b=document.createElement("img");b.className="menuClose";b.src=micello.maps.request.CLOSE_URL;b.onclick=function(){a.setActive(false)};b.ontouchstart=function(){a.setActive(false)};o.appendChild(b)}if(g.commands){var h;var c=g.commands.length;for(h=0;h<c;h++){var m=document.createElement("li");m.className="menuItem";var f=g.commands[h];var k=document.createElement("a");k.className="menuLink";k.href="";k.innerHTML=f.name;k.cmd=f;k.onclick=function(p){p.preventDefault();a.setActive(false);this.cmd.func();return false};k.ontouchstart=function(){a.setActive(false);this.cmd.func();return false};m.appendChild(k);n.appendChild(m)}}var j=document.createElement("div");j.className="menuTip";n.appendChild(j);this.menuWrapperDiv.appendChild(n);this.mainDiv.style.display="none";this.isVisible=false;this.parentElement.appendChild(this.mainDiv)};micello.maps.MapPopup.prototype.createInfoPopup=function(c){this.mainDiv=document.createElement("div");this.mainDiv.className="infoOut";this.mainDiv.setAttribute("id","infoDiv");this.mainDiv.style.position="absolute";this.mainDiv.style.zIndex=micello.maps.MapGUI.POPUP_ZINDEX;this.mainDiv.style.bottom="0px";this.mainDiv.style.left="0px";this.containerX=0;this.containerY=0;this.wrapperDiv=document.createElement("div");this.wrapperDiv.className="infoWrapper";this.mainDiv.appendChild(this.wrapperDiv);var f=document.createElement("div");f.className="infoBack";f.className+=" micello-rounded";f.className+=" micello-pop-shadow";this.wrapperDiv.appendChild(f);this.mainDiv.mapTarget=true;var n=document.createElement("div");n.className="infoIn";var h=this.view.getViewportWidth();var g=this.view.getViewportHeight();var k=Math.floor(h*micello.maps.MapPopup.MAX_FRACTION);if(k>micello.maps.MapPopup.MAX_WIDTH){k=micello.maps.MapPopup.MAX_WIDTH}var m=Math.floor(g*micello.maps.MapPopup.MAX_FRACTION);if(m>micello.maps.MapPopup.MAX_HEIGHT){m=micello.maps.MapPopup.MAX_HEIGHT}n.style.maxWidth=k+"px";n.style.maxHeight=m+"px";f.appendChild(n);var j=document.createElement("div");j.className="menuTip";this.wrapperDiv.appendChild(j);if(c.html){if(c.html.tagName){n.appendChild(c.html)}else{n.innerHTML=c.html}}var a=this;var b=document.createElement("img");b.className="infoClose";b.src=micello.maps.request.CLOSE_URL;b.onclick=function(){a.setActive(false)};b.ontouchstart=function(o){a.setActive(false)};f.appendChild(b);this.mainDiv.style.display="none";this.isVisible=false;this.parentElement.appendChild(this.mainDiv)};micello.geom={};micello.geom.linearRoots=function(f,c,g){if(f==0){return 0}else{g[0]=-c/f;return 1}};micello.geom.quadraticRoots=function(g,f,m,h){if(g==0){return micello.geom.linearRoots(f,m,h)}var k=f*f-4*g*m;if(k<0){return 0}else{var j=-f/(2*g);k=Math.sqrt(k)/(2*g);h[0]=j+k;h[1]=j-k;return 2}};micello.geom.cubicRoots=function(o,m,j,f,g){if(o!=0){m=m/o;j=j/o;f=f/o;o=1}else{return micello.geom.quadraticRoots(m,j,f,g)}var p=m/(3*o);var n=1/(3*o);var k=2*m*m*m-9*o*m*j+27*o*o*f;var q=m*m-3*o*j;var h=k*k-4*q*q*q;if(h>0){return micello.geom.caseOne(p,n,k,h,g)}else{if(h==0){return micello.geom.caseTwo(p,n,k,g)}else{return micello.geom.caseThree(p,n,k,h,g)}}};micello.geom.caseOne=function(k,j,h,g,f){var c=Math.sqrt(g);var b=micello.geom.cubeRoot(0.5*(h+c));var a=micello.geom.cubeRoot(0.5*(h-c));f[0]=-k-j*b-j*a;return 1};micello.geom.caseTwo=function(g,f,c,b){var a=micello.geom.cubeRoot(0.5*c);b[0]=-g-2*f*a;b[2]=b[1]=-g+f*a;return 3};micello.geom.caseThree=function(p,o,n,m,k){var a=Math.sqrt(-m);var b=Math.atan2(a,n);var f=0.5*Math.sqrt(n*n-m);var j=b/3;var h=j+2*Math.PI/3;var g=j-2*Math.PI/3;var c=micello.geom.cubeRoot(f);k[0]=-p-2*o*c*Math.cos(j);k[1]=-p-2*o*c*Math.cos(h);k[2]=-p-2*o*c*Math.cos(g);return 3};micello.geom.cubeRoot=function(a){if(a==0){return 0}else{if(a>0){return Math.exp(Math.log(a)/3)}else{return -Math.exp(Math.log(-a)/3)}}};micello.geom.intersectLine=function(b,g,a,f,h,k){if(b==a){return 0}else{var j=(h-b)/(a-b);if((j>=0)&&(j<1)){var c=(f-g)*j+g;if(c>k){return 1}else{return 0}}else{return 0}}};micello.geom.intersectQuad=function(g,p,c,o,a,n,b,m){var k=new Array(2);var r=0;var j=micello.geom.quadraticRoots((a-2*c+g),(c-g),(g-b),k);for(var h=0;h<j;h++){var f=k[h];if((f>=0)&&(f<1)){var q=(n-2*o+p)*f*f+2*(o-p)*f+p;if(q>m){r++}}}return r};micello.geom.intersectCube=function(h,r,f,q,c,p,a,n,b,o){var m=new Array(3);var t=0;var k=micello.geom.cubicRoots((a-3*c+3*f-h),3*(c-2*f+h),3*(f-h),(h-b),m);for(var j=0;j<k;j++){var g=m[j];if((g>=0)&&(g<1)){var s=(n-3*p+3*q-r)*g*g*g+3*(p-2*q+r)*g*g+3*(q-r)*g+r;if(s>o){t++}}}return t};micello.geom.cubeMinMax=function(h,f,b,a,p,j){var n=new Array(5);var m=micello.geom.quadraticRoots(3*(a-3*b+3*f-h),6*(b-2*f+h),3*(f-h),n);n[m++]=0;n[m++]=1;var o=p?0:1;for(var k=0;k<m;k++){var g=n[k];if((g>=0)&&(g<=1)){var c=(a-3*b+3*f-h)*g*g*g+3*(b-2*f+h)*g*g+3*(f-h)*g+h;if(c<j[0][o]){j[0][o]=c}if(c>j[1][o]){j[1][o]=c}}}};micello.geom.quadMinMax=function(g,c,a,o,h){var m=new Array(4);var k=micello.geom.linearRoots(2*(a-2*c+g),2*(c-g),m);m[k++]=0;m[k++]=1;var n=o?0:1;for(var j=0;j<k;j++){var f=m[j];if((f>=0)&&(f<=1)){var b=(a-2*c+g)*f*f+2*(c-g)*f+g;if(b<h[0][n]){h[0][n]=b}if(b>h[1][n]){h[1][n]=b}}}};micello.geom.lineMinMax=function(b,a,f,c){var g=f?0:1;if(b<c[0][g]){c[0][g]=b}if(b>c[1][g]){c[1][g]=b}if(a<c[0][g]){c[0][g]=a}if(a>c[1][g]){c[1][g]=a}};micello.geom.pathHit=function(o,j,h){var m;var b=o.length;var a=0;var n=0;var k=0;var f=null;var c=null;for(var g=0;g<b;g++){m=o[g];switch(m[0]){case 0:n=m[1];k=m[2];if((f)&&(c)){if((n!=f)||(k!=c)){a+=micello.geom.intersectLine(n,k,f,c,j,h)}}f=n;c=k;break;case 1:a+=micello.geom.intersectLine(n,k,m[1],m[2],j,h);n=m[1];k=m[2];break;case 2:a+=micello.geom.intersectQuad(n,k,m[1],m[2],m[3],m[4],j,h);n=m[3];k=m[4];break;case 3:a+=micello.geom.intersectCube(n,k,m[1],m[2],m[3],m[4],m[5],m[6],j,h);n=m[5];k=m[6];break;case 4:if((f)&&(c)){if((n!=f)||(k!=c)){a+=micello.geom.intersectLine(n,k,f,c,j,h)}}break}}return((a&1)!=0)};micello.geom.getInvalidMinMax=function(){return[[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY],[Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY]]};micello.geom.loadPathMinMax=function(h,g){var b;var a=h.length;var f=0;var c=0;for(var j=0;j<a;j++){b=h[j];switch(b[0]){case 0:f=b[1];c=b[2];if(!g){g=[[f,c],[f,c]]}break;case 1:micello.geom.lineMinMax(f,b[1],true,g);micello.geom.lineMinMax(c,b[2],false,g);f=b[1];c=b[2];break;case 2:micello.geom.quadMinMax(f,b[1],b[3],true,g);micello.geom.quadMinMax(c,b[2],b[4],false,g);f=b[3];c=b[4];break;case 3:micello.geom.cubeMinMax(f,b[1],b[3],b[5],true,g);micello.geom.cubeMinMax(c,b[2],b[4],b[6],false,g);f=b[5];c=b[6];break}}return g};micello.geom.rotRectHit=function(b,j,g){var k=j-b[0];var h=g-b[1];var a=Math.cos(b[4]);var m=Math.sin(b[4]);var f=-m;var c=a;return((Math.abs(k*a+h*m)<=b[2]/2)&&(Math.abs(k*f+h*c)<=b[3]/2))};micello.geom.loadRotRectMinMax=function(j,h){var n=Math.cos(j[4]);var o=Math.sin(j[4]);var m=(Math.abs(n*j[2])+Math.abs(o*j[3]))/2;var k=(Math.abs(o*j[2])+Math.abs(n*j[3]))/2;var g=j[0]-m;var f=j[1]-k;var b=j[0]+m;var a=j[1]+k;if(!h){h=[[g,f],[b,a]]}else{h[0][0]=Math.min(g,h[0][0]);h[0][1]=Math.min(f,h[0][1]);h[1][0]=Math.max(b,h[1][0]);h[1][1]=Math.max(a,h[1][1])}return h};micello.maps.request={};micello.maps.request.LOGO_URL=micello.SCRIPT_URL+"/resources/logo.png";micello.maps.request.CLOSE_URL=micello.SCRIPT_URL+"/resources/close10.png";micello.maps.request.CALLOUT_URL=micello.SCRIPT_URL+"/resources/callout34.png";micello.maps.request.LOADING_URL=micello.SCRIPT_URL+"/resources/mload.gif";micello.maps.request.loadCommunity=function(g,f,a,c){if(a===undefined){a="-"}if(c===undefined){c="-"}var b=micello.maps.HOST_URL+"/map/"+g+"/mv/"+a+"/ev/"+c+"/v5_map/com-map/"+micello.maps.lang;micello.maps.request.doRequest(b,f,micello.maps.onMapError,"GET")};micello.maps.request.loadDrawingEntity=function(h,b,g,a,f){if(a===undefined){a="-"}if(f===undefined){f="-"}var c=micello.maps.HOST_URL+"/map/"+h+"/mv/"+a+"/ev/"+f+"/v5_map/drawing-entity/"+b+"/"+micello.maps.lang;micello.maps.request.doRequest(c,g,micello.maps.onMapError,"GET")};micello.maps.request.loadLevelGeom=function(j,b,f,h,a,g){if(a===undefined){a="-"}if(g===undefined){g="-"}var c=micello.maps.HOST_URL+"/map/"+j+"/mv/"+a+"/ev/"+g+"/v5_map/level-geom/"+f+"/"+micello.maps.lang;micello.maps.request.doRequest(c,h,micello.maps.onMapError,"GET")};micello.maps.request.loadDataObject=function(a,b){micello.maps.request.doRequest(a,b,micello.maps.onMapError,"GET")};micello.maps.request.loadGeomDetail=function(j,c,g,a,f){if(a===undefined){a="-"}if(f===undefined){f="-"}if((c)&&(c.id)){var h=function(k){g(c,k)};var b=micello.maps.HOST_URL+"/map/"+j+"/mv/"+a+"/ev/"+f+"/v5_map/geom-detail/"+c.id+"/"+micello.maps.lang;micello.maps.request.doRequest(b,h,micello.maps.onMapError,"GET")}};micello.maps.request.loadEntityDetail=function(j,b,g,a,f){if(a===undefined){a="-"}if(f===undefined){f="-"}if((b)&&(b.id)){var h=function(k){g(b,k)};var c=micello.maps.HOST_URL+"/map/"+j+"/mv/"+a+"/ev/"+f+"/v5_map/entity-detail/"+b.id+"/"+micello.maps.lang;micello.maps.request.doRequest(c,h,micello.maps.onMapError,"GET")}};micello.maps.request.routeRequest=function(h,n,k,m,o,j){if((h)&&(n)&&(k)){var b;var f;var g='{"type":"route","form":"v5","start":[';b=n.length;for(f=0;f<b;f++){if(f>0){g+=","}g+=this.getRouteLocation(n[f])}g+='],"end":[';b=k.length;for(f=0;f<b;f++){if(f>0){g+=","}g+=this.getRouteLocation(k[f])}g+="]}";if(o===undefined){o="-"}if(j===undefined){j="-"}var c=function(p){if(p.msg){micello.maps.onMapError(p.msg)}if(p.annotation){m(p.annotation)}};var a=micello.maps.ROUTE_URL+"/route/"+h+"/mv/"+o+"/ev/"+j+"/"+micello.maps.lang;micello.maps.request.doRequest(a,c,micello.maps.onMapError,"POST",g)}};micello.maps.request.getRouteLocation=function(b){var a='{"t":"';a+=b.t;a+='",';if(b.t=="gid"){a+='"gid":'+b.gid;if(b.lid){a+=',"lid":'+b.lid}if(b.alt){a+=',"alt":'+this.getRouteLocation(b.alt)}a+="}"}else{if(b.t=="mc"){a+='"mx":'+b.mx;a+=',"my":'+b.my;a+=',"lid":'+b.lid;a+="}"}}return a};micello.maps.request.userInput=function(c,b,a){alert("User input not implemented")};micello.maps.request.doRequest=function(url,onDownload,onFailure,httpMethod,body){var xmlhttp;var doIe=false;url=url+"?"+micello.maps.request.getStdParams();if(window.XDomainRequest){xmlhttp=new XDomainRequest();xmlhttp.timeout=10000;doIe=true}else{if(window.XMLHttpRequest){xmlhttp=new XMLHttpRequest()}else{onFailure("This browser is not supported.");return}}if(!doIe){xmlhttp.dataManager=this;xmlhttp.onreadystatechange=function(){var msg;if(xmlhttp.readyState==4&&xmlhttp.status==200){var data=eval("("+xmlhttp.responseText+")");if(data.error){msg="Error in request: "+data.error;onFailure(msg)}else{onDownload(data)}}else{if(xmlhttp.readyState==4&&xmlhttp.status>=400){msg="Error in http request. Status: "+xmlhttp.status;onFailure(msg)}}}}else{xmlhttp.onload=function(){var data=eval("("+xmlhttp.responseText+")");if(data.error){msg="Error in request: "+data.error;onFailure(msg)}else{onDownload(data)}};xmlhttp.onerror=function(){msg="Error in http request. Status: "+xmlhttp.status;onFailure(msg)};xmlhttp.ontimeout=function(){return};xmlhttp.onprogress=function(){return}}xmlhttp.open(httpMethod,url,true);if(!doIe){if(httpMethod=="POST"){xmlhttp.setRequestHeader("Content-Type","text/plain")}}if(!doIe){xmlhttp.send(body)}else{setTimeout(function(){xmlhttp.send(body)},0)}};micello.maps.request.getStdParams=function(){var a="key="+micello.maps.key;return a};micello.maps.request.errorHandler=function(a){document.getElementById("micello-map").style.backgroundImage="none";e=document.createElement("div");e.innerHTML="Micello Map: "+a;e.setAttribute("id","micello-map-msg");e.style.top=0;e.style.left=0;e.style.padding="7px";e.style.border="1px solid #666";e.style.backgroundColor="#fff";e.style.position="absolute";document.body.appendChild(e);setTimeout(function(b){eM=document.getElementById("micello-map-msg");eM.style.display="none"},7000)};micello.maps.onMapError=micello.maps.request.errorHandler;micello.maps.mapproblem={};micello.maps.mapproblem.getProblemReportHTML=function(b,a){micello.maps.mapproblem.geom=a;micello.maps.mapproblem.mapControl=b;mapGUI=b.getMapGUI();var c=document.createElement("div");c.setAttribute("id","mapproblem");mpTitle=document.createElement("div");mpTitle.setAttribute("id","mapproblem-title");mpTitle.innerHTML="Report a Problem";c.appendChild(mpTitle);if((a)&&(a.nm)){mpSubTitle=document.createElement("div");mpSubTitle.setAttribute("id","mapproblem-subtitle");mpSubTitle.innerHTML+=a.nm;c.appendChild(mpSubTitle)}mpDesc=document.createElement("div");mpDesc.setAttribute("id","mapproblem-desc");mpDesc.innerHTML="Do you see something that requires attention? ";c.appendChild(mpDesc);mpTextArea=document.createElement("div");mpTextArea.setAttribute("id","mapproblem-textarea");c.appendChild(mpTextArea);mpTextAreaActual=document.createElement("textarea");mpTextAreaActual.setAttribute("id","_prob_text");mpTextArea.appendChild(mpTextAreaActual);mpTextAreaActual.focus();mpButton=document.createElement("div");mpButton.setAttribute("id","mapproblem-button");mpButton.innerHTML="Send Report";mpButton.onclick=function(){micello.maps.mapproblem.submitAction()};mpButton.ontouchend=function(){micello.maps.mapproblem.submitAction()};mpTextArea.appendChild(mpButton);mpTextAreaActual.onfocus=function(){mapGUI.KEY_COMMANDS=false};mpTextAreaActual.onblur=function(){mapGUI.KEY_COMMANDS=true};return c};micello.maps.mapproblem.submitAction=function(){var b=document.getElementById("_prob_text");var a=b.value;if(!a){mpDesc=document.getElementById("mapproblem-desc");mpDesc.innerHTML='<span class="mapproblem-error">Please enter a message</span>';return false}mpButton=document.getElementById("mapproblem-button");mpButton.onclick=false;mpButton.ontouchend=false;mpButton.innerHTML="Sending...";mpButton.style.backgroundColor="#ccc";mpButton.style.color="#fff";micello.maps.mapproblem.submitProblemInfo()};micello.maps.mapproblem.submitProblemInfo=function(){var f=document.getElementById("_prob_text");var c=f.value;var a=null;var b=micello.maps.mapproblem.geom;a=micello.maps.mapproblem.mapControl.getMapData().getCommunity();micello.maps.request.userInput(c,b,a)};micello.maps.mapproblem.onSuccess=function(){var a=document.getElementById("mapproblem");a.innerHTML="";mpTitle=document.createElement("div");mpTitle.setAttribute("id","mapproblem-title");mpTitle.innerHTML="Thank You!";a.appendChild(mpTitle);mpDesc=document.createElement("div");mpDesc.setAttribute("id","mapproblem-desc");mpDesc.innerHTML="We have received your map feedback and we will address your submission as soon as possible. ";a.appendChild(mpDesc);mpButton=document.createElement("div");mpButton.setAttribute("id","mapproblem-button-complete");mpButton.innerHTML="I'm Done";mpButton.onclick=function(){micello.maps.mapproblem.mapControl.hideInfoWindow()};mpButton.ontouchend=function(){micello.maps.mapproblem.mapControl.hideInfoWindow()};a.appendChild(mpButton)};micello.maps.mapproblem.onFailure=function(){var a=document.getElementById("mapproblem");a.innerHTML="";mpTitle=document.createElement("div");mpTitle.setAttribute("id","mapproblem-title");mpTitle.innerHTML="We Had A Problem";a.appendChild(mpTitle);mpDesc=document.createElement("div");mpDesc.setAttribute("id","mapproblem-desc");mpDesc.innerHTML="Your submission unfortunately did not go through successfully. Please try again.";a.appendChild(mpDesc)};micello.maps.MapMomentum=function(a){this.mapCanvas=a;this.sC=[];this.maxDelta=350;this.length="2.0s";this.mmThreshold="20";this.div="";this.nm="mapMomentum";this.style=null;this.running=false};micello.maps.MapMomentum.prototype.begin=function(h,g,c,a,b){this.div=h;this.sC[0]=g;this.sC[1]=[];this.cB=[0,1,0,1];this.mvC=c;this.spC=a;this.aC=[Math.abs(this.spC[0]/b*100),Math.abs(this.spC[1]/b*100)];var f=this;if(this.aC[0]<this.mmThreshold||this.aC[1]<this.mmThreshold){return}this.createRules();micello.util.addCss(this.div,{webkitAnimationName:this.nm,animationName:this.nm,webkitAnimationIterationCount:1,animationIterationCount:1,webkitAnimationPlayState:"running",animationPlayState:"running",webkitAnimationDuration:this.length,animationDuration:this.length,webkitAnimationTimingFunction:"cubic-bezier("+this.cB[0]+","+this.cB[1]+","+this.cB[2]+","+this.cB[3]+")",animationTimingFunction:"cubic-bezier("+this.cB[0]+","+this.cB[1]+","+this.cB[2]+","+this.cB[3]+")",});animEndHandler=function(j){f.animationEnd()};animStartHandler=function(j){f.running=true};this.div.addEventListener("webkitAnimationEnd",animEndHandler);this.div.addEventListener("animationEnd",animEndHandler);this.div.addEventListener("webkitAnimationStart",animStartHandler);this.div.addEventListener("animationStart",animStartHandler)};micello.maps.MapMomentum.prototype.animationEnd=function(){this.mapCanvas.view.translate(this.sC[1][0]-this.sC[0][0],this.sC[1][1]-this.sC[0][1]);micello.util.addCss(this.div,{webkitAnimationName:"",animationName:"",webkitAnimationPlayState:"paused",animationPlayState:"paused",});this.removeKeyFrameRule();this.running=false;this.div.removeEventListener("webkitAnimationEnd",animEndHandler);this.div.removeEventListener("animationEnd",animEndHandler);this.div.removeEventListener("webkitAnimationStart",animStartHandler);this.div.removeEventListener("animationStart",animStartHandler)};micello.maps.MapMomentum.prototype.createRules=function(){if(this.mvC[0]>this.maxDelta){this.mvC[0]=this.maxDelta}if(this.mvC[0]<-this.maxDelta){this.mvC[0]=-this.maxDelta}if(this.mvC[1]>this.maxDelta){this.mvC[1]=this.maxDelta}if(this.mvC[1]<-this.maxDelta){this.mvC[1]=-this.maxDelta}var b=this.sC[0][0]+this.mvC[0];var a=this.sC[0][1]+this.mvC[1];this.sC[1][0]=b;this.sC[1][1]=a;rule=this.nm+" {    0% {        top: "+this.sC[0][1]+"px;        left: "+this.sC[0][0]+"px;    }    100% {        top: "+this.sC[1][1]+"px;        left: "+this.sC[1][0]+"px;    }}";this.addKeyFrameRule(rule)};micello.maps.MapMomentum.prototype.addKeyFrameRule=function(b){this.style=micello.util.addElem("mapAnim","style");document.head.appendChild(this.style);var a=micello.util.vendorPrefix();if(a.css!="-ms-"){this.style.sheet.insertRule("@"+a.css+"keyframes "+b,0)}else{this.style.sheet.insertRule("@keyframes "+b,0)}};micello.maps.MapMomentum.prototype.removeKeyFrameRule=function(){var a=this.style.sheet?this.style.sheet:this.style.styleSheet;if(a.cssRules){if(a.cssRules.length>0){a.deleteRule(0)}}};micello.maps.MapMomentum.prototype.killMomentum=function(){if(this.running===true){this.sC[1][0]=this.div.offsetLeft;this.sC[1][1]=this.div.offsetTop;this.animationEnd()}};micello.maps.MapEvent=function(a){this.events=[];this.mapControl=a};micello.maps.MapEvent.prototype.addListener=function(a,b){if(!b){return}if(!this.events[a]){this.events[a]=[]}this.events[a].push(b)};micello.maps.MapEvent.prototype.removeListener=function(b,g){var a=[];var f=null;for(i=0;i<this.events[b].length;i++){if(g!==this.events[b][i]){f=this.events[b][i];a[b].push(f)}}this.events[b]=a};micello.maps.MapEvent.prototype.orderListener=function(b,j,g){var a=[];var h=null;var f=null;for(i=0;i<this.events[b].length;i++){if(j===this.events[b][i]){f=this.events[b][i];break}}if(g=="first"){a.push(f)}for(i=0;i<this.events[b].length;i++){if(j!==this.events[b][i]){h=this.events[b][i];a.push(h)}}if(g=="last"){a.push(f)}this.events[b]=a};micello.maps.MapEvent.prototype.priorityFirstListener=function(a,b){this.orderListener(a,b,"first")};micello.maps.MapEvent.prototype.priorityLastListener=function(a,b){this.orderListener(a,b,"last")};micello.maps.MapEvent.prototype.dispatchEvent=function(a,b){var c=null;if(!b){b={}}if(!this.events[a]){return}for(i=0;i<this.events[a].length;i++){c=this.events[a][i];if(c){c.call(null,b)}}};micello.maps.StandardInfoWindow=function(a){this.themeMap=a;this.geom=null;this.entities=null;this.geomDetail=null;this.entityDetails={};this.table=null};micello.maps.StandardInfoWindow.prototype.createInfoElement=function(j,k){var g=k.id;var n=k.mv;var h=k.ev;this.table=document.createElement("table");this.table.className="infoTable";if((j.me)&&(j.me.length>0)){if((j.ie)&&(j.ie.length>0)){this.entities=j.me.concat(j.ie)}else{this.entities=j.me}}else{if((j.ie)&&(j.ie.length>0)){this.entities=j.ie}else{this.entities=null}}this.populateData(j,this.entities);var m=this;if(j.d==1){var a=function(o,p){m.updateGeomDetail(o,p)};micello.maps.request.loadGeomDetail(g,j,a,n,h)}else{this.geomDetails=j}var f;var b;if(this.entities){var c=function(o,p){m.updateEntityDetail(o,p)};for(f=0;f<this.entities.length;f++){b=this.entities[f];if(b.d==1){micello.maps.request.loadEntityDetail(g,b,c,n,h)}else{this.entityDetails[String(b.id)]=b}}}return this.table};micello.maps.StandardInfoWindow.prototype.populateData=function(f,h){var c;var a;var g;var j;var b;if(h){for(c=0;c<h.length;c++){a=h[c];g=a.p;if(g){b=this.themeMap.getEntityLabel(a);if(b){j=this.themeMap.convertLabelToText(b);if(j){this.addObjectDetail(j,g)}}}}}b=this.themeMap.getGeomLabel(f);if(b){j=this.themeMap.convertLabelToText(b);if(j){g=f.p;this.addObjectDetail(j,g)}}};micello.maps.StandardInfoWindow.prototype.addObjectDetail=function(g,c){var n;var f=this.table.rows.length;var k;if(g){n=this.table.insertRow(f++);k=n.insertCell(0);k.className="infoTitle";k.colSpan="2";k.innerHTML=g}var m=[["description",null],["phone",this.getPhoneLink],["email",this.getEmailLink],["url",this.getHttpLink],["hours",null]];var a;var j;var h;var b;for(a=0;a<m.length;a++){j=m[a][0];b=m[a][1];h=c[j];if(h!=null){n=this.table.insertRow(f++);this.addInfoRow(j,h,b,n)}}};micello.maps.StandardInfoWindow.prototype.addInfoRow=function(c,h,b,j){var g=this.themeMap.translate("info:"+c,c);var a=j.insertCell(0);a.className="infoItemNm";a.innerHTML=g;a=j.insertCell(1);a.className="infoItemVal";if(b){var f=b(h);a.appendChild(f)}else{a.innerHTML=h}};micello.maps.StandardInfoWindow.prototype.updateGeomDetail=function(a,b){this.geomDetail=b;this.checkCompletion()};micello.maps.StandardInfoWindow.prototype.updateEntityDetail=function(a,b){this.entityDetails[String(a.id)]=b;this.checkCompletion()};micello.maps.StandardInfoWindow.prototype.checkCompletion=function(){if(!this.table.parentNode){return}var a=0;var f;for(f in this.entityDetails){a++}if((this.geomDetails)&&((!this.entities)||(a==this.entities.length))){var c;if(this.entities){c=[];for(var b=0;b<this.entities.length;b++){f=this.entities[b].id;c.push(this.entityDetails[String(f)])}}while(this.table.rows.length>0){this.table.deleteRow(this.table.rows.length-1)}this.populateData(this.geomDetails,c)}};micello.maps.StandardInfoWindow.prototype.getPhoneLink=function(a){var b="tel:"+a.replace(/[^\d]/g,"");return micello.maps.getUrlLink(b,a,false)};micello.maps.StandardInfoWindow.prototype.getEmailLink=function(a){var b="mailto:"+a;return micello.maps.getUrlLink(b,a,false)};micello.maps.StandardInfoWindow.prototype.getHttpLink=function(a){var c=a.substr(0,7).toLowerCase();if(c!="http://"){a="http://"+a}var b;b=(a.length>micello.maps.MapControl.MAX_URL_LENGTH)?"<em>click to open</em>":a;return micello.maps.getUrlLink(a,b,true)};micello.maps.getUrlLink=function(a,f,c){var b=document.createElement("a");b.href=a;if(c){b.target="_blank"}b.innerHTML=f;return b};micello.maps.MapControl=function(a){if(!micello.maps.key){micello.maps.onMapError("You must have a Micello Map Key to user the Micello Map API.");return}this.mapName=a;this.createControl(a);this.selectInlay={id:0,zi:micello.maps.MapControl.SELECT_ZINDEX,po:{"$style":"Selected"},anm:"slct"};this.popup=this.mapCanvas.createPopup();var b=this;this.mapCanvas.onMapClick=function(f,c,g){b.onMapClick(f,c,g)};this.doSelectAction=this.defaultSelectAction;this.showInfo=this.showDefaultInfoWindow;this.selected=null;this.highlighted=false;this.routeTo=null;this.routeFrom=null;this.routeActive=false;this.routeOverlay=null;this.popupFlags=micello.maps.MapControl.SHOW_ALL;this.themeMap=null;this.initializeTheme()};micello.maps.MapControl.SELECT_ZINDEX=9999;micello.maps.MapControl.SHOW_INFO=1;micello.maps.MapControl.SHOW_INSIDE=2;micello.maps.MapControl.SHOW_NAV=4;micello.maps.MapControl.SHOW_REPORT=8;micello.maps.MapControl.SHOW_ALL=15;micello.maps.MapControl.MAX_URL_LENGTH=25;micello.maps.MapControl.prototype.getMapData=function(){return this.data};micello.maps.MapControl.prototype.getMapView=function(){return this.view};micello.maps.MapControl.prototype.getMapCanvas=function(){return this.mapCanvas};micello.maps.MapControl.prototype.getMapGUI=function(){return this.mapGUI};micello.maps.MapControl.prototype.getThemeMap=function(){return this.themeMap};micello.maps.MapControl.prototype.getMapEvent=function(){return this.mapEvent};micello.maps.MapControl.prototype.requestNavToGeom=function(f,g,b){var c={};c.t="gid";if(f.gid){c.gid=f.gid}else{c.gid=f.id}if((b)&&(g)){c.lid=g}if((f.l)&&(g)){c.alt={};c.alt.t="mc";c.alt.mx=f.l[0];c.alt.my=f.l[1];c.alt.lid=g}var a=[];a.push(c);this.requestNavTo(a)};micello.maps.MapControl.prototype.requestNavFromGeom=function(c,g,a){var b={};b.t="gid";if(c.gid){b.gid=c.gid}else{b.gid=c.id}if((a)&&(g)){b.lid=g}if((c.l)&&(g)){b.alt={};b.alt.t="mc";b.alt.mx=c.l[0];b.alt.my=c.l[1];b.alt.lid=g}var f=[];f.push(b);this.requestNavFrom(f)};micello.maps.MapControl.prototype.requestNavTo=function(a){this.data.removeAnnotation("route");this.routeTo=a;this.setRouteMarker(true);if((this.routeTo)&&(this.routeFrom)&&(this.routeTo.gid==this.routeFrom.gid)&&(this.routeTo.gid)){this.routeFrom=null}else{if(this.routeFrom){this.setRouteMarker(false);this.getRoute()}}this.mapEvent.dispatchEvent("routeTo",a)};micello.maps.MapControl.prototype.requestNavFrom=function(a){this.data.removeAnnotation("route");this.routeFrom=a;this.setRouteMarker(false);if((this.routeTo)&&(this.routeFrom)&&(this.routeTo.gid==this.routeFrom.gid)&&(this.routeTo.gid)){this.routeTo=null}else{if(this.routeTo){this.setRouteMarker(true);this.getRoute()}}this.mapEvent.dispatchEvent("routeFrom",a)};micello.maps.MapControl.prototype.clearRoute=function(){this.routeTo=null;this.routeFrom=null;this.routeActive=false;this.data.removeAnnotation("route");this.mapEvent.dispatchEvent("routeCleared")};micello.maps.MapControl.prototype.getRoute=function(){if((this.routeTo)&&(this.routeFrom)){this.routeActive=true;var f=this;var g=this.data.getCommunity().id;var a=this.data.mapVersion;var c=this.data.entityVersion;var b=function(h){f.data.removeAnnotation("route");f.showAnnotation(h,"route");f.mapEvent.dispatchEvent("routeReceived",h)};micello.maps.request.routeRequest(g,this.routeFrom,this.routeTo,b,a,c)}};micello.maps.MapControl.prototype.setRouteMarker=function(c){var b=null;var f;var g;if(c){g=this.routeTo;f="RouteEnd"}else{g=this.routeFrom;f="RouteStart"}if((g!=null)&&(g.length==1)){b=g[0].gid;if(b){var a={id:b,mr:f,mt:1,anm:"route"};this.data.addMarkerOverlay(a,true)}}};micello.maps.MapControl.prototype.reportProb=function(b){var a=micello.maps.mapproblem.getProblemReportHTML(this,b);this.showInfoWindow(b,a);var c=document.getElementById("_prob_text");c.focus()};micello.maps.MapControl.prototype.showPopupMenu=function(f,c,a){var b=new Object();b.type=micello.maps.popuptype.MENU;b.title=c;b.commands=a;if((f.mx===undefined)||(f.my===undefined)){return false}b.mapX=f.mx;b.mapY=f.my;if(f.ox===undefined){b.ox=0;b.oy=10}else{b.ox=f.ox;b.oy=0}if(f.lid){b.lid=f.lid}else{if(f.lvl){b.lid=f.lvl.id}else{return false}}this.popup.setData(b);this.popup.setActive(true);return true};micello.maps.MapControl.prototype.showInfoWindow=function(c,a){var b=new Object();b.type=micello.maps.popuptype.INFOWINDOW;b.html=a;if((c.mx===undefined)||(c.my===undefined)){return false}b.mapX=c.mx;b.mapY=c.my;if(c.ox===undefined){b.ox=0;b.oy=10}else{b.ox=c.ox;b.oy=0}if(c.lid){b.lid=c.lid}else{if(c.lvl){b.lid=c.lvl.id}else{return false}}this.popup.setData(b);this.popup.setActive(true);return true};micello.maps.MapControl.prototype.hideInfoWindow=function(){this.popup.setActive(false)};micello.maps.MapControl.prototype.defaultSelectAction=function(b){if(!b){this.popup.setActive(false)}else{var a=this.getTitleInfo(b);if(a!=null){this.showDefaultGeomPopup(b,a)}else{this.popup.setActive(false)}}};micello.maps.MapControl.prototype.getTitleInfo=function(b){if(this.themeMap==null){return null}var a=this.themeMap.getLabel(b);if(a){return this.themeMap.convertLabelToText(a)}else{return null}};micello.maps.MapControl.prototype.showDefaultGeomPopup=function(b,c){var a=new Array();if(this.popupFlags&micello.maps.MapControl.SHOW_INFO){this.loadInfoCmd(b,a,c)}if(this.popupFlags&micello.maps.MapControl.SHOW_INSIDE){this.loadInsideCmd(b,a)}if(this.popupFlags&micello.maps.MapControl.SHOW_NAV){this.loadNavCmd(b,a)}if(this.popupFlags&micello.maps.MapControl.SHOW_REPORT){this.loadInputCmd(b,a)}this.showPopupMenu(b,c,a)};micello.maps.MapControl.prototype.showDefaultInfoWindow=function(b){var a=this.data.getCommunity();if(!a){return}var f=new micello.maps.StandardInfoWindow(this.themeMap);var c=f.createInfoElement(b,a);this.popup.setActive(false);this.showInfoWindow(b,c)};micello.maps.MapControl.prototype.centerOnGeom=function(a,b){if(!a){return}if(!b){b=0}if(!a.mm){this.mapCanvas.loadGeomMinMax(a)}this.view.defaultMapX=(a.mm[1][0]+a.mm[0][0])/2;this.view.defaultMapY=(a.mm[1][1]+a.mm[0][1])/2;this.view.defaultW=2*(a.mm[1][0]-a.mm[0][0])+b;this.view.defaultH=2*(a.mm[1][1]-a.mm[0][1])+b;this.view.resetView();this.mapCanvas.onZoom();if(this.onViewChange){this.event.pan=0;this.event.zoom=1;this.onViewChange(this.event)}};micello.maps.MapControl.prototype.initMapPlugin=function(a){a.mapControl=this;a.mapGUI=this.getMapGUI();a.mapCanvas=this.getMapCanvas();a.mapData=this.getMapData();a.mapView=this.getMapView()};micello.maps.MapControl.prototype.loadInfoCmd=function(b,a,f){if((b.id>0)&&(f)){var g=this;var c={name:"Info",func:function(){g.showInfo(b)}};a.push(c)}};micello.maps.MapControl.prototype.loadInsideCmd=function(b,a){var f=this;var c;if(b.cid){c={name:"Go Inside",func:function(){f.toEmbeddedCom(b)}};a.push(c)}else{if(b.did){c={name:"Go Inside",func:function(){f.toEmbeddedDraw(b)}};a.push(c)}}};micello.maps.MapControl.prototype.loadNavCmd=function(b,a){if(b.id){var c;if(b.lid){c=b.lid}else{if(b.lvl){c=b.lvl.id}else{return}}var g=this;var f={name:"Navigate To",func:function(){g.requestNavToGeom(b,c,true)}};a.push(f);f={name:"Navigate From",func:function(){g.requestNavFromGeom(b,c,true)}};a.push(f);if(this.routeActive){f={name:"Clear Route",func:function(){g.clearRoute()}};a.push(f)}}};micello.maps.MapControl.prototype.loadInputCmd=function(b,a){if(b.id){var f=this;var c={name:"Report a problem",func:function(){f.reportProb(b)}};a.push(c)}};micello.maps.MapControl.prototype.toEmbeddedCom=function(b){var a=this.data.getCommunity();var c=b.did;if((c)&&(c!=a.id)){this.data.loadCommunity(c,b.did,b.lid)}else{micello.maps.onMapError("Unknown error - go inside failed")}};micello.maps.MapControl.prototype.toEmbeddedDraw=function(f){var a=this.data.getCommunity();var g=f.did;if((a)&&(a.d)&&(g)){var c;var b=a.d.length;for(c=0;c<b;c++){var h=a.d[c];if(h.id==g){this.data.setDrawing(h,f.lid)}}}else{micello.maps.onMapError("Unknown error - go inside failed")}};micello.maps.MapControl.prototype.onMapClick=function(b,a,c){if((c!=null)&&((c.pdat)||(c.idat)||(c.p))){if(c!=this.selected){this.selectObject(c)}}else{if(this.selected!=null){this.deselectObject()}}if(this.doSelectAction){this.doSelectAction(c)}};micello.maps.MapControl.prototype.selectObject=function(a){if(this.highlighted){this.data.removeInlay("slct",true)}if((a.id)&&(a.gt==micello.maps.geomtype.AREA)){this.selectInlay.id=a.id;this.data.addInlay(this.selectInlay);this.highlighted=true}else{this.highlighted=false}this.selected=a};micello.maps.MapControl.prototype.deselectObject=function(){if(this.highlighted){this.data.removeInlay("slct",true)}this.selected=null;this.highlighted=false};micello.maps.MapControl.prototype.showAnnotation=function(j,b){var f=j.g;var a=j.i;var g=j.m;var h;var c;if(f){for(c=0;c<f.length;c++){h=f[c];if(b){h.anm=b}this.data.addGeometryOverlay(h)}}if(a){for(c=0;c<a.length;c++){h=a[c];if(b){h.anm=b}this.data.addGeometryOverlay(h)}}if(g){for(c=0;c<g.length;c++){h=g[c];if(b){h.anm=b}this.data.addMarkerOverlay(h)}}};micello.maps.MapControl.prototype.createControl=function(f){this.mapEvent=new micello.maps.MapEvent(this);this.mapGUI=new micello.maps.MapGUI(this,f,this.mapEvent);var b=this.mapGUI.viewportElement;var a=this.mapGUI.mapElement;this.mapCanvas=new micello.maps.MapCanvas(this,a,this.mapEvent);this.view=new micello.maps.MapView(this,b,a,this.mapCanvas,this.mapGUI,this.mapEvent);this.data=new micello.maps.MapData(this,this.view,this.mapCanvas,this.mapGUI,this.mapEvent);this.mapGUI.mapCanvas=this.mapCanvas;this.mapGUI.data=this.data;this.mapGUI.view=this.view;this.mapCanvas.data=this.data;this.mapCanvas.view=this.view;var g=this;var c=function(j){var h=g.data.getCommunity();if(h.id==j.id){g.loadCommunityOverrides(h)}};this.mapEvent.addListener("communityloaded",c)};micello.maps.MapControl.prototype.initializeTheme=function(){this.themeMap=new micello.maps.ThemeMap(this.mapEvent);var b=this.mapCanvas;var a=function(c){b.drawMap()};this.mapEvent.addListener("themeloaded",a);if(micello.maps.themeMapUrl){this.themeMap.setThemeMapUrl(micello.maps.themeMapUrl)}else{if(micello.maps.themeMapName){this.themeMap.setThemeMapName(micello.maps.themeMapName)}}if(micello.maps.themeUrl){this.themeMap.setThemeUrl(micello.maps.themeUrl)}else{if(micello.maps.themeName){this.themeMap.setThemeName(micello.maps.themeName)}}if(micello.maps.stringsUrl){this.themeMap.setStringsUrl(micello.maps.stringsUrl)}else{if(micello.maps.stringsName){this.themeMap.setStringsName(micello.maps.stringsName)}}this.themeMap.loadData();this.mapCanvas.themeMap=this.themeMap};micello.maps.MapControl.prototype.loadCommunityOverrides=function(b){if(b.or){var j=b.or;var a=this.themeMap;if(j.stringsUrls){var f=function(k){a.addStrings(k)};this.loadUrlObjects(j.stringsUrls,f)}if(j.themeMapUrls){var g=function(k){a.addThemeMap(k)};this.loadUrlObjects(j.themeMapUrls,g)}if((j.themeUrls)&&(!micello.maps.themeUrl)&&(micello.maps.themeName)){var c=j.themeUrls[micello.maps.themeName];if((c)&&(c.length>0)){var h=function(k){a.addTheme(k)};this.loadUrlObjects(c,h)}}}};micello.maps.MapControl.prototype.loadUrlObjects=function(g,f){if(!g){return}var h=this.mapCanvas;var c=function(j){f(j);h.clearRenderCache()};for(var b=0;b<g.length;b++){var a=g[b];micello.maps.request.loadDataObject(a,c)}};if(micello.maps.initCallback){micello.maps.initCallback()};